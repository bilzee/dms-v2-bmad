# Story 9.2: Critical Infrastructure Fixes

**QA Gate Status**: FAIL  
**Priority**: P0 - Blocking  
**Estimated Time**: 2-4 hours  
**Created**: September 5, 2025  

## Overview

While Story 9.2 has extensive implementation, critical integration failures prevent functional assessment and deployment. This document provides research-backed instructions to resolve the infrastructure issues.

## Issue Summary

1. **Database Integration Failure**: RoleHistory table not accessible by Prisma client
2. **Test Infrastructure Breakdown**: Jest configuration prevents TypeScript/JSX tests from running
3. **TypeScript Compilation Errors**: Multiple type mismatches throughout role management modules

## Fix Instructions

### 🔧 Fix 1: Database Integration (Priority 1)

**Problem**: RoleHistory table exists in schema but not accessible by Prisma client, causing compilation errors in DatabaseService.

**Root Cause**: Prisma client not regenerated after schema changes.

**Solution Steps**:
```bash
# 1. Navigate to frontend package
cd packages/frontend

# 2. Uninstall and reinstall Prisma client (clears cache)
pnpm remove @prisma/client
pnpm add @prisma/client

# 3. Regenerate Prisma client with new schema
pnpm prisma generate

# 4. Restart TypeScript language server in IDE
# In VS Code: Ctrl+Shift+P > "TypeScript: Restart TS Server"

# 5. Verify database connection and schema
pnpm prisma db push  # Only if needed to sync schema
```

**Verification**:
```bash
# Check that RoleHistory is now accessible
pnpm --filter @dms/frontend run typecheck
# Should show fewer errors related to roleHistory property
```

**Research Source**: Based on [Prisma GitHub issues #14722](https://github.com/prisma/prisma/issues/14722) and [Stack Overflow solutions](https://stackoverflow.com/questions/72043619/prisma-generated-types-not-updating) for Prisma type generation issues in 2024.

---

### 🧪 Fix 2: Jest Test Configuration (Priority 1)

**Problem**: Jest encountering "Unexpected token" errors with TypeScript/JSX files, preventing any tests from running.

**Root Cause**: Jest configuration not properly set up for pnpm workspace monorepo with Next.js and TypeScript.

**Solution Steps**:

1. **Update Jest configuration** (`packages/frontend/jest.config.js`):
```javascript
const nextJest = require('next/jest')

const createJestConfig = nextJest({
  // Provide the path to your Next.js app to load next.config.js and .env files
  dir: './',
})

// Add any custom config to be passed to Jest
const customJestConfig = {
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
  testEnvironment: 'jest-environment-jsdom',
  testPathIgnorePatterns: [
    '<rootDir>/.next/',
    '<rootDir>/node_modules/',
  ],
  moduleNameMapper: {
    // Handle module aliases (if using @/ imports)
    '^@/(.*)$': '<rootDir>/src/$1',
    '^@shared/(.*)$': '<rootDir>/../shared/$1',
  },
  transform: {
    // Handle TypeScript and JSX files
    '^.+\\.(ts|tsx|js|jsx)$': ['babel-jest', { presets: ['next/babel'] }],
  },
  transformIgnorePatterns: [
    '/node_modules/',
    '^.+\\.module\\.(css|sass|scss)$',
  ],
  collectCoverageFrom: [
    'src/**/*.{js,jsx,ts,tsx}',
    '!src/**/*.d.ts',
    '!src/app/globals.css',
  ],
}

// createJestConfig is exported this way to ensure that next/jest can load the Next.js config which is async
module.exports = createJestConfig(customJestConfig)
```

2. **Create Jest setup file** (`packages/frontend/jest.setup.js`):
```javascript
import '@testing-library/jest-dom'

// Mock Next.js router
jest.mock('next/router', () => require('next-router-mock'))

// Mock environment variables if needed
process.env.NODE_ENV = 'test'
```

3. **Install missing dependencies**:
```bash
cd packages/frontend
pnpm add -D @testing-library/jest-dom jest-environment-jsdom next-router-mock
```

4. **Update package.json test script**:
```json
{
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage"
  }
}
```

**Verification**:
```bash
# Test the Jest configuration
cd packages/frontend
pnpm test --passWithNoTests
# Should run without "Unexpected token" errors

# Run specific role management tests
pnpm test RoleAssignmentModal.test.tsx
```

**Research Source**: Based on [Next.js Jest configuration guide](https://nextjs.org/docs/testing/jest) and [pnpm monorepo Jest setup patterns](https://jsdev.space/complete-monorepo-guide/) from 2024.

---

### 📝 Fix 3: TypeScript Compilation Errors (Priority 2)

**Problem**: Multiple TypeScript errors in role management modules preventing build.

**Key Errors to Fix**:

1. **SharedTypes Import Error** (`src/lib/services/NotificationService.ts:2`):
```typescript
// Replace this:
import { AdminRole, AdminUser } from '@shared/types/admin';

// With this:
import { AdminRole, AdminUser } from '../../../../shared/types/admin';
```

2. **DatabaseService Private Property Access** (Multiple files):
```typescript
// In NotificationService.ts, replace direct prisma access:
// DatabaseService.prisma.notification.create(...)

// With proper public method calls:
await DatabaseService.createNotification(notificationData);
```

3. **Missing activeRole Property in Mock Data** (Test files):
```typescript
// Add activeRole to user mock objects:
const mockUser = {
  id: 'user-1',
  name: 'John Doe',
  email: 'john@example.com',
  activeRole: null,  // Add this
  roles: [
    { id: 'role-1', name: 'RESPONDER' }
  ]
};
```

**Fix Script** (Run from project root):
```bash
# Check current TypeScript errors
cd packages/frontend
pnpm run typecheck > typescript-errors.log 2>&1

# Fix the most critical errors first
# Then re-run typecheck to see progress
pnpm run typecheck
```

**Research Source**: Based on [TypeScript monorepo configuration patterns](https://medium.com/@cecylia.borek/setting-up-a-monorepo-using-npm-workspaces-and-typescript-project-references-307841e0ba4a) and workspace-specific import resolution issues.

---

### 🔄 Fix 4: Notification System Completion (Priority 2)

**Problem**: Bulk role assignment has TODO for notification system.

**Location**: `packages/frontend/src/app/api/v1/admin/users/bulk-roles/route.ts:109-112`

**Solution**:
```typescript
// Replace the TODO block:
if (notifyUsers && successful.length > 0) {
  console.log(`TODO: Send bulk role assignment notification to ${successful.length} users`);
}

// With actual implementation:
if (notifyUsers && successful.length > 0) {
  try {
    const promises = successful.map(result => {
      if (result.user) {
        const user = { 
          id: result.user.id, 
          name: result.user.name || 'Unknown', 
          email: result.user.email || '' 
        };
        const admin = { id: adminUserId, name: adminUserName };
        
        return NotificationService.sendRoleAssignmentNotification(
          user,
          assignedRoles,
          [], // No removed roles in bulk assignment
          admin,
          reason
        );
      }
    });
    
    await Promise.allSettled(promises);
  } catch (notificationError) {
    console.error('Failed to send bulk notifications:', notificationError);
    // Don't fail the operation if notifications fail
  }
}
```

---

## Verification Checklist

After completing all fixes:

- [ ] **Database**: `pnpm prisma generate` runs successfully
- [ ] **TypeScript**: `pnpm run typecheck` shows minimal errors
- [ ] **Tests**: `pnpm test --passWithNoTests` runs without Jest errors
- [ ] **Role Tests**: `pnpm test RoleAssignmentModal.test.tsx` executes
- [ ] **Build**: `pnpm run build` completes successfully
- [ ] **Notification**: Bulk role assignment includes notification calls

## Post-Fix Actions

1. **Re-run QA Review**: Request QA to re-evaluate with `*review 9.2`
2. **Update Story Status**: Change from "Changes Required" to "Review"  
3. **Update File List**: Add any new configuration files created
4. **Test Coverage**: Add missing integration tests for complete workflows

## Time Estimates

- **Fix 1 (Database)**: 30-45 minutes
- **Fix 2 (Jest)**: 60-90 minutes  
- **Fix 3 (TypeScript)**: 45-60 minutes
- **Fix 4 (Notifications)**: 30 minutes
- **Verification**: 15-30 minutes

**Total**: 3-4.5 hours

## Support Resources

- [Prisma Troubleshooting Guide](https://www.prisma.io/docs/orm/prisma-client/setup-and-configuration/generating-prisma-client)
- [Next.js Jest Configuration](https://nextjs.org/docs/testing/jest)
- [pnpm Workspace Documentation](https://pnpm.io/workspaces)
- Original QA Review: `docs/qa/gates/9.2-role-assignment-permissions.yml`

---

**Created by**: Quinn (Test Architect)  
**Next Review**: After all P1 fixes completed