# Dev Instructions: Story 2.5 Test Fixes (COMPREHENSIVE)

**Date**: 2025-08-25  
**QA Agent**: Quinn (Test Architect)  
**Severity**: CRITICAL  
**Story**: 2.5 - Response Status Review  
**Updated**: Added web research-based fixes for shadcn/ui testing issues

## Issue Summary

All component tests for Story 2.5 are failing due to multiple issues with shadcn/ui component testing. This prevents verification of component functionality and blocks production deployment.

**Primary Error Patterns**:
1. **Multiple Elements Found**: `Found multiple elements with the text` (when tabs render same content multiple times)
2. **PointerEvent Missing**: shadcn/ui components require PointerEvent constructor for proper interaction
3. **Component Mocking Issues**: Insufficient mocking of Radix UI-based components (Tabs, Select, Collapsible)
4. **Tab State Management**: Mock components don't handle controlled state changes

## Root Cause Analysis

Based on research of shadcn/ui testing patterns:

1. **shadcn/ui built on Radix UI** - requires PointerEvent mocking for interactions
2. **Multiple DOM elements** - tabs render same content across multiple panels
3. **Controlled component state** - mocks don't properly handle state management
4. **Complex component structure** - Radix primitives have internal complexity not suitable for testing

## Required Fixes

### 1. **CRITICAL: Add PointerEvent Support for shadcn/ui Components**

**Problem**: shadcn/ui components built on Radix UI use PointerEvent for interactions, but tests don't have PointerEvent constructor.

**Files to Update**:
- `packages/frontend/src/components/features/response/__tests__/ResponseStatusReview.test.tsx`
- `packages/frontend/src/components/features/response/__tests__/CoordinatorFeedback.test.tsx`

**Add to top of BOTH test files (after imports):**
```typescript
// Mock PointerEvent for shadcn/ui components
function createMockPointerEvent(type: string, props: PointerEventInit = {}): PointerEvent {
  const event = new Event(type, props) as PointerEvent;
  Object.assign(event, {
    button: props.button || 0,
    ctrlKey: props.ctrlKey || false,
    pointerType: props.pointerType || "mouse",
  });
  return event;
}

// Setup PointerEvent and HTMLElement methods
beforeAll(() => {
  (window as any).PointerEvent = createMockPointerEvent;
  Object.assign(window.HTMLElement.prototype, {
    scrollIntoView: jest.fn(),
    releasePointerCapture: jest.fn(),
    hasPointerCapture: jest.fn(),
    setPointerCapture: jest.fn(),
  });
});
```

### 2. **CRITICAL: Fix Tabs Mock to Handle Controlled State**

**Problem**: Current Tabs mock renders all tab content simultaneously, causing "multiple elements found" errors.

**File**: `packages/frontend/src/components/features/response/__tests__/ResponseStatusReview.test.tsx`

**REPLACE the existing Tabs mock with this improved version:**
```typescript
jest.mock('@/components/ui/tabs', () => {
  const React = require('react');
  
  return {
    Tabs: ({ children, value, onValueChange, ...props }: any) => {
      return (
        <div data-testid="tabs" data-value={value} {...props}>
          {React.Children.map(children, (child: any) => {
            if (React.isValidElement(child)) {
              if (child.type?.name === 'TabsTrigger') {
                return React.cloneElement(child, {
                  'data-active': child.props.value === value,
                  onClick: (e: any) => {
                    e.preventDefault();
                    onValueChange?.(child.props.value);
                  }
                });
              }
              if (child.type?.name === 'TabsContent') {
                // CRITICAL: Only render active tab content to prevent multiple elements
                return child.props.value === value ? React.cloneElement(child, {
                  'data-active': true,
                  style: { display: 'block' }
                }) : null;
              }
            }
            return child;
          })}
        </div>
      );
    },
    TabsList: ({ children, ...props }: any) => <div data-testid="tabs-list" {...props}>{children}</div>,
    TabsTrigger: ({ children, value, onClick, ...props }: any) => (
      <button 
        data-testid="tabs-trigger" 
        data-value={value}
        onClick={onClick}
        {...props}
      >
        {children}
      </button>
    ),
    TabsContent: ({ children, value, style, ...props }: any) => (
      <div data-testid="tabs-content" data-value={value} style={style} {...props}>
        {children}
      </div>
    ),
  };
});
```

### 3. **CRITICAL: Fix Multiple Elements Query Strategy**

**Problem**: Tests use `getByText` when multiple elements have same text across tab panels.

**Files**: Both test files need query strategy updates

**Key Changes Needed:**

**A. Fix "filters responses when switching to rejected tab" test:**
```typescript
it('filters responses when switching to rejected tab', async () => {
  const user = userEvent.setup();
  
  render(
    <ResponseStatusReview
      responses={mockResponses}
      onResponseSelect={mockOnResponseSelect}
      onResubmissionRequest={mockOnResubmissionRequest}
    />
  );

  // Click the rejected tab trigger
  const rejectedTabTrigger = screen.getByTestId('tabs-trigger');
  const rejectedTab = screen.getByText('Rejected (1)');
  await user.click(rejectedTab);

  // Wait for tab switch and check only active content
  await waitFor(() => {
    // Only John Doe (REJECTED) should be visible in active tab content
    const activeTabContent = screen.getByTestId('tabs-content');
    
    // Use getAllByText since we expect John Doe content
    const johnDoeElements = screen.getAllByText((content) => 
      content.includes('Responder:') && content.includes('John Doe')
    );
    expect(johnDoeElements.length).toBeGreaterThan(0);
    
    // Jane Smith and Bob Johnson should NOT appear (they should be 0)
    expect(screen.queryAllByText((content) => 
      content.includes('Responder:') && content.includes('Jane Smith')
    )).toHaveLength(0);
    expect(screen.queryAllByText((content) => 
      content.includes('Responder:') && content.includes('Bob Johnson')
    )).toHaveLength(0);
  });
});
```

**B. Add data-testid to response cards in component:**

**File**: `packages/frontend/src/components/features/response/ResponseStatusReview.tsx`

**Update around line 245:**
```typescript
<Card 
  key={response.id}
  data-testid={`response-card-${response.id}`}  // ADD THIS LINE
  className={`cursor-pointer transition-colors hover:bg-accent ${
    response.requiresAttention ? 'border-orange-500' : ''
  } ${
    selectedResponse?.id === response.id ? 'bg-accent' : ''
  }`}
  onClick={() => handleResponseClick(response)}
>
```

**C. Fix response interaction tests:**
```typescript
it('calls onResponseSelect when response card is clicked', async () => {
  const user = userEvent.setup();
  
  render(
    <ResponseStatusReview
      responses={mockResponses}
      onResponseSelect={mockOnResponseSelect}
      onResubmissionRequest={mockOnResubmissionRequest}
    />
  );

  // Use specific data-testid instead of text search
  const responseCard = screen.getByTestId('response-card-resp-001');
  await user.click(responseCard);

  expect(mockOnResponseSelect).toHaveBeenCalledWith(mockResponses[0]);
});
```

### 4. **Add Collapsible Component Mock for CoordinatorFeedback**

**Problem**: CoordinatorFeedback uses Collapsible components that need proper interaction.

**File**: `packages/frontend/src/components/features/response/__tests__/CoordinatorFeedback.test.tsx`

**Add this mock (after imports, before other mocks):**
```typescript
jest.mock('@/components/ui/collapsible', () => {
  const React = require('react');
  
  return {
    Collapsible: ({ children, open, onOpenChange, ...props }: any) => {
      return (
        <div data-testid="collapsible" data-open={open} {...props}>
          {React.Children.map(children, (child: any) => {
            if (React.isValidElement(child)) {
              if (child.type?.name === 'CollapsibleTrigger') {
                return React.cloneElement(child, {
                  onClick: () => onOpenChange?.(!open)
                });
              }
              if (child.type?.name === 'CollapsibleContent') {
                return open ? child : null;
              }
            }
            return child;
          })}
        </div>
      );
    },
    CollapsibleContent: ({ children, ...props }: any) => (
      <div data-testid="collapsible-content" {...props}>{children}</div>
    ),
    CollapsibleTrigger: ({ children, onClick, ...props }: any) => (
      <button data-testid="collapsible-trigger" onClick={onClick} {...props}>
        {children}
      </button>
    ),
  };
});
```

### 5. **Improve Select Component Mock with Interaction**

**Problem**: Current Select mock doesn't handle proper user interactions.

**File**: `packages/frontend/src/components/features/response/__tests__/ResponseStatusReview.test.tsx`

**REPLACE the existing Select mock:**
```typescript
jest.mock('@/components/ui/select', () => {
  const React = require('react');
  
  return {
    Select: ({ children, value, onValueChange, ...props }: any) => {
      const [isOpen, setIsOpen] = React.useState(false);
      return (
        <div data-testid="select" data-value={value} {...props}>
          {React.Children.map(children, (child: any) => {
            if (React.isValidElement(child)) {
              if (child.type?.name === 'SelectTrigger') {
                return React.cloneElement(child, {
                  onClick: () => setIsOpen(!isOpen)
                });
              }
              if (child.type?.name === 'SelectContent') {
                return isOpen ? React.cloneElement(child, {
                  onSelect: (itemValue: string) => {
                    onValueChange?.(itemValue);
                    setIsOpen(false);
                  }
                }) : null;
              }
            }
            return child;
          })}
        </div>
      );
    },
    SelectContent: ({ children, onSelect, ...props }: any) => (
      <div data-testid="select-content" {...props}>
        {React.Children.map(children, (child: any) => 
          React.isValidElement(child) && child.type?.name === 'SelectItem' 
            ? React.cloneElement(child, { onSelect })
            : child
        )}
      </div>
    ),
    SelectItem: ({ children, value, onSelect, ...props }: any) => (
      <div 
        data-testid="select-item" 
        data-value={value} 
        onClick={() => onSelect?.(value)}
        {...props}
      >
        {children}
      </div>
    ),
    SelectTrigger: ({ children, onClick, ...props }: any) => (
      <button data-testid="select-trigger" onClick={onClick} {...props}>{children}</button>
    ),
    SelectValue: ({ placeholder, ...props }: any) => (
      <span data-testid="select-value" data-placeholder={placeholder} {...props} />
    )
  };
});
```

### 6. **OPTIONAL: Create UI Component Mocks (Alternative Approach)**

**Create**: `packages/frontend/src/components/__mocks__/ui/`

Add mock files for all shadcn/ui components used in Story 2.5:

**File**: `packages/frontend/src/components/__mocks__/ui/badge.tsx`
```typescript
import React from 'react';

export const Badge = ({ children, className, variant, ...props }: any) => (
  <span data-testid="badge" className={className} data-variant={variant} {...props}>
    {children}
  </span>
);
```

**File**: `packages/frontend/src/components/__mocks__/ui/card.tsx`
```typescript
import React from 'react';

export const Card = ({ children, className, ...props }: any) => (
  <div data-testid="card" className={className} {...props}>
    {children}
  </div>
);

export const CardContent = ({ children, className, ...props }: any) => (
  <div data-testid="card-content" className={className} {...props}>
    {children}
  </div>
);

export const CardDescription = ({ children, className, ...props }: any) => (
  <div data-testid="card-description" className={className} {...props}>
    {children}
  </div>
);

export const CardHeader = ({ children, className, ...props }: any) => (
  <div data-testid="card-header" className={className} {...props}>
    {children}
  </div>
);

export const CardTitle = ({ children, className, ...props }: any) => (
  <h3 data-testid="card-title" className={className} {...props}>
    {children}
  </h3>
);
```

**File**: `packages/frontend/src/components/__mocks__/ui/tabs.tsx`
```typescript
import React from 'react';

export const Tabs = ({ children, defaultValue, value, onValueChange, ...props }: any) => (
  <div data-testid="tabs" data-value={value || defaultValue} {...props}>
    {children}
  </div>
);

export const TabsList = ({ children, className, ...props }: any) => (
  <div data-testid="tabs-list" className={className} {...props}>
    {children}
  </div>
);

export const TabsTrigger = ({ children, value, className, ...props }: any) => (
  <button data-testid="tabs-trigger" data-value={value} className={className} {...props}>
    {children}
  </button>
);

export const TabsContent = ({ children, value, className, ...props }: any) => (
  <div data-testid="tabs-content" data-value={value} className={className} {...props}>
    {children}
  </div>
);
```

**File**: `packages/frontend/src/components/__mocks__/ui/button.tsx`
```typescript
import React from 'react';

export const Button = ({ children, className, variant, size, onClick, disabled, ...props }: any) => (
  <button 
    data-testid="button" 
    className={className} 
    data-variant={variant}
    data-size={size}
    onClick={onClick}
    disabled={disabled}
    {...props}
  >
    {children}
  </button>
);
```

**File**: `packages/frontend/src/components/__mocks__/ui/input.tsx`
```typescript
import React from 'react';

export const Input = ({ className, type, placeholder, value, onChange, ...props }: any) => (
  <input
    data-testid="input"
    className={className}
    type={type}
    placeholder={placeholder}
    value={value}
    onChange={onChange}
    {...props}
  />
);
```

**File**: `packages/frontend/src/components/__mocks__/ui/select.tsx`
```typescript
import React from 'react';

export const Select = ({ children, value, onValueChange, ...props }: any) => (
  <div data-testid="select" data-value={value} {...props}>
    {children}
  </div>
);

export const SelectContent = ({ children, ...props }: any) => (
  <div data-testid="select-content" {...props}>
    {children}
  </div>
);

export const SelectItem = ({ children, value, ...props }: any) => (
  <div data-testid="select-item" data-value={value} {...props}>
    {children}
  </div>
);

export const SelectTrigger = ({ children, className, ...props }: any) => (
  <div data-testid="select-trigger" className={className} {...props}>
    {children}
  </div>
);

export const SelectValue = ({ placeholder, ...props }: any) => (
  <span data-testid="select-value" data-placeholder={placeholder} {...props} />
);
```

**File**: `packages/frontend/src/components/__mocks__/ui/scroll-area.tsx`
```typescript
import React from 'react';

export const ScrollArea = ({ children, className, ...props }: any) => (
  <div data-testid="scroll-area" className={className} {...props}>
    {children}
  </div>
);
```

### 3. **Update Jest Configuration**

**File**: `packages/frontend/jest.config.js`

Add or update the moduleNameMapping section:
```javascript
module.exports = {
  // ... existing config
  moduleNameMapping: {
    // ... existing mappings
    '^@/components/ui/(.*)$': '<rootDir>/src/components/__mocks__/ui/$1',
  },
  setupFilesAfterEnv: [
    '<rootDir>/src/test/setup.ts'
  ],
  // ... rest of config
};
```

### 4. **Create Test Setup File**

**File**: `packages/frontend/src/test/setup.ts`
```typescript
import '@testing-library/jest-dom';

// Mock IntersectionObserver
global.IntersectionObserver = class IntersectionObserver {
  constructor() {}
  observe() {
    return null;
  }
  disconnect() {
    return null;
  }
  unobserve() {
    return null;
  }
};

// Mock ResizeObserver
global.ResizeObserver = class ResizeObserver {
  constructor() {}
  observe() {
    return null;
  }
  disconnect() {
    return null;
  }
  unobserve() {
    return null;
  }
};
```

### 5. **Update Test Files**

**Update**: `packages/frontend/src/components/features/response/__tests__/ResponseStatusReview.test.tsx`

Add proper component mocking at the top:
```typescript
// Mock shadcn/ui components
jest.mock('@/components/ui/badge', () => ({
  Badge: ({ children, ...props }: any) => <span data-testid="badge" {...props}>{children}</span>
}));

jest.mock('@/components/ui/card', () => ({
  Card: ({ children, ...props }: any) => <div data-testid="card" {...props}>{children}</div>,
  CardContent: ({ children, ...props }: any) => <div data-testid="card-content" {...props}>{children}</div>,
  CardDescription: ({ children, ...props }: any) => <div data-testid="card-description" {...props}>{children}</div>,
  CardHeader: ({ children, ...props }: any) => <div data-testid="card-header" {...props}>{children}</div>,
  CardTitle: ({ children, ...props }: any) => <h3 data-testid="card-title" {...props}>{children}</h3>,
}));

// Add similar mocks for tabs, button, input, select, scroll-area
```

## Implementation Priority & Steps

### STEP 1: Quick Test Validation (5 minutes)
```bash
cd packages/frontend
pnpm test ResponseStatusReview.test.tsx --verbose
```
**Expected**: See the specific failure patterns described above

### STEP 2: Apply Core Fixes (15 minutes)
1. **Add PointerEvent mock** (fixes #1) - both test files
2. **Replace Tabs mock** (fixes #2) - ResponseStatusReview.test.tsx 
3. **Add data-testid to response cards** (fixes #3) - ResponseStatusReview.tsx component

### STEP 3: Test & Iterate (10 minutes)
```bash
pnpm test ResponseStatusReview.test.tsx
```
**Target**: Get from 11/17 to 17/17 tests passing

### STEP 4: Apply to CoordinatorFeedback (10 minutes)
1. **Add PointerEvent mock** - CoordinatorFeedback.test.tsx
2. **Add Collapsible mock** - CoordinatorFeedback.test.tsx

### STEP 5: Comprehensive Validation (5 minutes)
```bash
# Test all Story 2.5 components  
pnmp test "response.*test.tsx"

# Full test suite
pnpm test

# Check test coverage
pnpm test --coverage
```

**Expected Result**: All Story 2.5 tests passing + no regressions

## Success Criteria

- [ ] All ResponseStatusReview component tests pass (17/17)
- [ ] All CoordinatorFeedback component tests pass  
- [ ] No "multiple elements found" errors
- [ ] No PointerEvent-related errors
- [ ] Tab switching works correctly in tests
- [ ] Response card interactions trigger properly
- [ ] Collapsible components expand/collapse in tests
- [ ] Test coverage maintained at >80%
- [ ] No test regressions in other components

## Common Issues & Solutions

### Issue: "Found multiple elements with the text"
**Solution**: Use `getAllByText` instead of `getByText`, or scope queries with `within()`

### Issue: "PointerEvent is not a constructor"  
**Solution**: Add PointerEvent mock with `createMockPointerEvent` function

### Issue: Tab content appears multiple times
**Solution**: Use improved Tabs mock that only renders active tab content

### Issue: Collapsible components don't toggle
**Solution**: Add proper Collapsible mock with state management

## Web Research References

- **Testing shadcn/ui Select**: https://stackoverflow.com/questions/78975098/testing-shadcn-select-with-jest-and-react-testing-library
- **Multiple Elements Error**: https://stackoverflow.com/questions/68943625/found-multiple-elements-error-in-react-testing-library  
- **shadcn/ui Testing Discussion**: https://github.com/shadcn-ui/ui/discussions/4168
- **PointerEvent mocking**: Required for Radix UI components that shadcn/ui is built on

## Notes for Dev Agent

- **Root Cause**: shadcn/ui uses Radix UI primitives that require specific testing patterns
- **Key Insight**: PointerEvent mocking is essential for shadcn/ui interaction testing
- **Strategy**: Mock components to simulate real user interactions while being deterministic
- **Quality Gate**: All tests must pass before Story 2.5 can be marked as "Production Ready"

## Validation Commands

```bash
# Quick validation
pnpm --filter @dms/frontend test ResponseStatusReview.test.tsx

# Full Story 2.5 validation  
pnpm --filter @dms/frontend test CoordinatorFeedback.test.tsx

# Comprehensive check
pnpm --filter @dms/frontend test --testPathPattern="response.*test.tsx"
```

## Contact

**QA Agent**: Quinn (Test Architect)  
**Review Date**: 2025-08-25  
**Updated**: Added comprehensive shadcn/ui testing patterns based on web research  
**Gate Status**: CRITICAL - Implementation complete but blocked by test infrastructure issues