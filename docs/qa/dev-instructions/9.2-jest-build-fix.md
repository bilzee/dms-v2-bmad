# Story 9.2: Jest Build Error Fix

**Issue**: `ReferenceError: jest is not defined` during production build  
**Priority**: P1 - Blocking production deployment  
**Status**: Requires immediate fix  
**Updated**: September 5, 2025  

## üö® **Problem Summary**

The Next.js production build is failing with `ReferenceError: jest is not defined` during page prerendering for `/admin/roles`. This prevents successful deployment despite all other infrastructure fixes being implemented.

**Error Location**: 
- Page: `/(dashboard)/admin/roles/page`
- Build Stage: Static page generation/prerendering  
- Root Cause: Jest test utilities leaking into production bundle

## üîç **Root Cause Analysis** 

Based on web research and error patterns, this issue occurs when:
1. **Test files placed in routing directories** (pages/ or app/ directories) 
2. **Jest imports accidentally included in production code**
3. **Webpack configuration not properly excluding test files**
4. **Test utilities imported in components that get bundled**

## üõ†Ô∏è **Research-Backed Solutions**

### **Solution 1: Verify Test File Location (Most Common Fix)**

**Problem**: Test files in routing directories get treated as pages by Next.js

**Steps**:
```bash
# 1. Check for test files in app directory
find src/app -name "*.test.*" -o -name "*.spec.*" -o -name "__tests__"

# 2. Check for Jest imports in production files
grep -r "jest\|@jest" src/app --exclude-dir=__tests__ --exclude="*.test.*"

# 3. Move any test files found to proper locations
# Example: Move from src/app/admin/roles/test.tsx to src/__tests__/admin/roles/
```

**Research Source**: [Next.js GitHub Discussion #35486](https://github.com/vercel/next.js/discussions/35486) - "Test files should not be placed inside the pages directory because Next.js treats any files inside the Pages Router as routes"

---

### **Solution 2: Configure Next.js to Exclude Test Files**

**Problem**: Webpack bundling test files into production build

**Implementation** (`next.config.js`):
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  webpack: (config, { dev, isServer }) => {
    // Exclude test files from production builds
    config.module.rules.push({
      test: /\.(test|spec)\.(js|jsx|ts|tsx)$/,
      use: 'ignore-loader',
    });

    // Exclude __tests__ directories
    config.module.rules.push({
      test: /__tests__/,
      use: 'ignore-loader',
    });

    return config;
  },
  
  // Alternative: Use page extensions to exclude test files
  pageExtensions: ['js', 'jsx', 'ts', 'tsx'].filter(ext => 
    !ext.includes('test') && !ext.includes('spec')
  ),
};

module.exports = nextConfig;
```

**Research Source**: [Stack Overflow - Exclude test files in Next.js](https://stackoverflow.com/questions/71305497/how-to-exclude-test-files-in-next-js-during-build)

---

### **Solution 3: Fix Jest Configuration Leakage**

**Problem**: Jest globals leaking into production environment

**Implementation** (`jest.config.js`):
```javascript
const nextJest = require('next/jest')

const createJestConfig = nextJest({
  dir: './',
})

const customJestConfig = {
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
  testEnvironment: 'jest-environment-jsdom',
  
  // Properly isolate test files
  testPathIgnorePatterns: [
    '<rootDir>/.next/',
    '<rootDir>/node_modules/',
  ],
  
  // Prevent test utilities from bundling
  modulePathIgnorePatterns: [
    '<rootDir>/.next/',
  ],
  
  // Only run tests on test files
  testMatch: [
    '**/__tests__/**/*.(js|jsx|ts|tsx)',
    '**/*.(test|spec).(js|jsx|ts|tsx)',
  ],
  
  // Exclude production files from Jest processing
  collectCoverageFrom: [
    'src/**/*.{js,jsx,ts,tsx}',
    '!src/**/*.d.ts',
    '!src/**/*.(test|spec).{js,jsx,ts,tsx}',
    '!src/**/__tests__/**',
  ],
}

module.exports = createJestConfig(customJestConfig)
```

**Research Source**: [Next.js Jest Documentation](https://nextjs.org/docs/pages/guides/testing/jest) and [Jest Configuration Guide](https://jestjs.io/docs/configuration)

---

### **Solution 4: TypeScript Configuration**

**Problem**: TypeScript including test files in build

**Implementation** (`tsconfig.json`):
```json
{
  "compilerOptions": {
    // ... existing options
  },
  "include": [
    "src/**/*"
  ],
  "exclude": [
    "node_modules",
    "**/*.test.*",
    "**/*.spec.*",
    "**/__tests__/**",
    ".next",
    "coverage"
  ]
}
```

---

## üîß **Diagnostic Commands**

**Run these to identify the issue**:
```bash
# 1. Find test files in routing directories
find packages/frontend/src/app -name "*.test.*" -o -name "*.spec.*"

# 2. Search for Jest imports in production code
grep -r "jest\|describe\|it\|expect" packages/frontend/src/app --exclude-dir=__tests__

# 3. Check webpack bundle for test code
pnpm build && grep -r "jest" .next/server/ | head -5

# 4. Verify Jest configuration
cat packages/frontend/jest.config.js
```

## ‚úÖ **Validation Steps**

**After implementing fixes**:
```bash
# 1. Clean build cache
rm -rf .next

# 2. Test build completion
pnpm run build

# 3. Verify no Jest references in production bundle
grep -r "jest is not defined" .next/server/ | wc -l
# Should return: 0

# 4. Test role management page specifically
curl -I http://localhost:3000/admin/roles
# Should return: 200 OK
```

## üéØ **Expected Outcome**

**Success Criteria**:
- ‚úÖ `pnpm run build` completes without errors
- ‚úÖ All 35+ static pages generate successfully  
- ‚úÖ No "jest is not defined" errors in build output
- ‚úÖ `/admin/roles` page accessible in production build

## ‚ö†Ô∏è **Implementation Priority**

**Critical Path**:
1. **Immediate**: Run diagnostic commands to locate Jest imports
2. **Fix**: Apply Solution 1 (move test files) or Solution 2 (webpack config)
3. **Verify**: Complete build success with validation steps
4. **Deploy**: Request QA re-review for final gate upgrade

## üìö **Research Sources**

- [Next.js Testing Documentation](https://nextjs.org/docs/pages/guides/testing/jest)
- [Stack Overflow: Jest ReferenceError](https://stackoverflow.com/questions/65190123/referenceerror-jest-is-not-defined-when-running-unit-test)
- [Next.js GitHub Discussion #23959](https://github.com/vercel/next.js/discussions/23959)
- [Webpack Bundle Analysis Guide](https://blog.logrocket.com/how-to-analyze-next-js-app-bundles/)

---

**Time Estimate**: 30-60 minutes  
**Complexity**: Medium (configuration issue)  
**Impact**: Unblocks production deployment of Story 9.2  

**Created by**: Quinn (Test Architect)  
**Next Action**: Implement Solution 1 or 2, then validate with build test