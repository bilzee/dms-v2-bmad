# Story 9.1: User Creation & Management

## Parent Epic
**Epic 9: User Management & Administration (MVP Priority: Medium)** - Story UM-001: User Creation & Management [Source: docs/prd/user-stories-epics.md]

## Status
Approved

## Story
**As an** Admin **I want to** create and manage user accounts **so that** I can control system access and maintain security

## Acceptance Criteria
1. **User account creation with role assignment**
   - Account creation form with required fields (email, name, phone, organization)
   - Role selection from available roles (ASSESSOR, RESPONDER, COORDINATOR, DONOR, ADMIN)
   - Initial password generation and secure delivery
   - Account activation workflow

2. **User profile management and updates**
   - Edit user profile information (name, phone, organization)
   - Update user roles and permissions
   - View user activity and last sync status
   - Search and filter user accounts

3. **Account activation/deactivation capability**
   - Toggle user account active/inactive status
   - Deactivated users cannot access system
   - Audit trail for activation/deactivation actions
   - Bulk activation/deactivation operations

4. **Bulk user import functionality**
   - CSV/Excel file upload for multiple user creation
   - Data validation and error reporting for bulk imports
   - Preview import data before processing
   - Email notifications to imported users with access credentials

## Tasks / Subtasks

- [ ] **Task 1: Database Schema & Type Definitions** (AC: 1, 2, 3, 4)
  - [ ] Update Prisma schema for User model with admin fields
  - [ ] Add UserRole model with permission relationships
  - [ ] Create audit trail tables for user management actions
  - [ ] Generate TypeScript types for user management interfaces

- [ ] **Task 2: API Endpoints for User Management** (AC: 1, 2, 3, 4)
  - [ ] POST `/api/v1/admin/users` - Create single user account
  - [ ] GET `/api/v1/admin/users` - List users with filtering/pagination
  - [ ] PUT `/api/v1/admin/users/:id` - Update user profile and roles
  - [ ] PUT `/api/v1/admin/users/:id/status` - Activate/deactivate account
  - [ ] POST `/api/v1/admin/users/bulk-import` - Bulk user import from CSV
  - [ ] GET `/api/v1/admin/users/export` - Export user data

- [ ] **Task 3: Admin User Management Interface** (AC: 1, 2, 3)
  - [ ] Create UserManagement page at `/admin/users`
  - [ ] Build UserList component with search/filter capabilities
  - [ ] Implement CreateUserModal with role assignment
  - [ ] Build EditUserModal for profile and role updates
  - [ ] Add user status toggle controls with confirmation dialogs

- [ ] **Task 4: Bulk Import System** (AC: 4)
  - [ ] Create BulkImportModal component
  - [ ] Implement CSV parser with validation
  - [ ] Build import preview table showing validation results
  - [ ] Add batch processing for large imports
  - [ ] Implement email notification system for new users

- [ ] **Task 5: Authentication & Authorization** (AC: 1, 2, 3, 4)
  - [ ] Add admin middleware for user management routes
  - [ ] Implement role-based access control for admin features
  - [ ] Add password generation and secure delivery system
  - [ ] Create audit logging for all user management actions

- [ ] **Task 6: Testing Implementation** (AC: 1, 2, 3, 4)
  - [ ] Unit tests for user management API endpoints
  - [ ] Integration tests for bulk import functionality
  - [ ] Component tests for user management interfaces
  - [ ] E2E tests for complete user management workflows

## Dev Notes

### Architecture Context

**Previous Story Insights**: No specific guidance found in architecture docs

**Data Models**: User management builds on existing User and UserRole interfaces [Source: docs/architecture/4-data-models.md]
- User interface includes: id, email, name, phone?, organization?, roles[], activeRole, permissions[], lastSync?, createdAt, updatedAt
- UserRole interface: id, name (ASSESSOR|RESPONDER|COORDINATOR|DONOR|ADMIN), permissions[], isActive
- Permission system already defined for role-based access control

**API Specifications**: No specific user management API endpoints found in current architecture docs

**Component Specifications**: Admin components should follow established React patterns [Source: docs/architecture/13-development-guidelines-for-llm-driven-development.md]
- Use TypeScript exclusively with explicit types
- Follow component implementation pattern: hooks first, state, effects, handlers, render
- Implement proper error handling with try-catch blocks
- Use consistent naming: camelCase for variables, PascalCase for components

**File Locations**: Based on project structure [Source: docs/architecture/source-tree.md]
- API Routes: `app/api/v1/admin/users/route.ts` and related endpoints
- Components: `src/components/features/admin/users/` directory
- Pages: `src/app/(dashboard)/admin/users/page.tsx`
- Types: `packages/shared/types/admin.ts` for admin-specific types
- Store: `src/stores/admin.store.ts` for admin state management

**Technical Constraints**: 
- Use Next.js 14.2.x with App Router [Source: docs/architecture/2-tech-stack.md]
- PostgreSQL 16.x with Prisma 5.14.x for database operations
- NextAuth.js 4.24.x for authentication management
- Implement proper TypeScript types and Zod validation schemas

**UI/UX Design Guidelines**: [Source: docs/architecture/2-tech-stack.md, docs/architecture/6-component-architecture.md]
- **Component Library**: Use Shadcn/ui components exclusively - customizable, accessible, lightweight
- **Styling Framework**: Tailwind CSS 3.4.x for utility-first styling with consistent design system
- **Component Structure**: Follow established component template pattern with explicit props interfaces
- **Admin Theme**: Implement professional admin interface with clear visual hierarchy
  - Primary actions: Blue theme (create, save, confirm)
  - Destructive actions: Red theme (delete, deactivate)
  - Status indicators: Green (active), Gray (inactive), Yellow (pending)
- **Form Design**: Use Shadcn Form components with proper validation feedback
- **Modal/Dialog Patterns**: Shadcn Dialog components for create/edit operations
- **Table Layout**: Shadcn Table components with sorting, filtering, and pagination
- **Search/Filter UI**: Integrated search bar with filter dropdowns and clear visual states

**Responsive Design Specifications**: [Source: docs/architecture/6-component-architecture.md]
- **Breakpoints**: Follow Tailwind CSS standard breakpoints (sm: 640px, md: 768px, lg: 1024px, xl: 1280px)
- **Mobile-First Approach**: Design for mobile first, enhance for larger screens
- **Desktop Layout**: Full table view with all columns visible, side-by-side modals
- **Tablet Layout**: Condensed table with priority columns, full-screen modals
- **Mobile Layout**: Card-based list view, full-screen modals, bottom sheet patterns
- **Navigation**: Collapsible sidebar on mobile, persistent on desktop

**Accessibility Requirements**: [Source: docs/architecture/2-tech-stack.md - Shadcn/ui accessibility features]
- **WCAG 2.1 AA Compliance**: Ensure all components meet accessibility standards
- **Keyboard Navigation**: Full keyboard support with logical tab order and focus indicators
- **Screen Reader Support**: Proper ARIA labels, roles, and descriptions
- **Color Contrast**: Minimum 4.5:1 ratio for text, 3:1 for UI elements
- **Focus Management**: Clear focus indicators and logical focus flow in modals
- **Error Handling**: Accessible error messages with screen reader announcements
- **Form Labels**: Explicit labels for all form inputs with error state descriptions
- **Status Announcements**: Live regions for dynamic content updates (bulk import progress)
- **Alternative Text**: Descriptive alt text for any icons or images used

### Testing

**Testing Requirements**: Follow established testing strategy patterns [Source: docs/qa/test-strategy.md referenced in CLAUDE.md]
- **Test File Location**: Place tests in `__tests__/` directories alongside components
- **Test Standards**: Use React Testing Library for component tests, Jest for unit tests
- **Testing Frameworks**: Jest + React Testing Library for frontend, Supertest for API testing
- **Specific Requirements**: 
  - Test user creation flow with validation
  - Test role assignment and permission verification
  - Test bulk import with various CSV formats and validation scenarios
  - Test account activation/deactivation workflows
  - Mock API endpoints for integration-ready tests [Source: CLAUDE.md Test Mocking guidance]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-04 | 1.1 | Added UI/UX design guidelines, responsive design specifications, and accessibility requirements | Product Owner |
| 2025-09-04 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled during development*

### Debug Log References
*To be filled during development*

### Completion Notes List
*To be filled during development*

### File List
*To be filled during development*

## QA Results

*Results from QA Agent review will be added here after story implementation*