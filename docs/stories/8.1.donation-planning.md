# Story 8.1: Donation Planning

## Parent Epic
**Epic 8: Donor Management System (MVP Priority: Medium)** - Story DM-001: Donation Planning [Source: docs/prd/user-stories-epics.md]

## Status
**Completed**

## Story
**As a** Donor **I want to** register my donation commitments **so that** I can contribute to coordinated response efforts

## Acceptance Criteria
1. **Donation commitment registration form**
   - Form validates required fields: donor name, organization, email, phone (optional)
   - Response type selection from enum: HEALTH, WASH, SHELTER, FOOD, SECURITY, POPULATION
   - Form prevents submission with invalid data and shows clear error messages
   - Auto-save functionality stores draft commitments locally
2. **Item type and quantity specification**
   - Quantity input accepts positive integers only (1-999999 range)
   - Unit field allows custom text input with 50 character limit
   - Validation prevents empty quantity or unit fields
   - Clear quantity + unit display format (e.g., "500 blankets")
3. **Delivery timeline planning**
   - Date picker enforces future dates only (minimum: tomorrow)
   - Maximum planning horizon: 365 days from current date
   - Calendar integration with clear date format display
   - Timezone handling for accurate delivery scheduling
4. **Commitment modification capability**
   - Edit mode allows quantity, unit, and target date changes
   - Status updates: PLANNED → DELIVERED → CANCELLED with reason codes
   - Modification history tracks all changes with timestamps
   - Cancel functionality requires confirmation dialog and reason selection

## Tasks / Subtasks
- [x] Setup Donor Authentication Integration (AC: 1) - PREREQUISITE
  - [x] Add donor role to existing authentication system from Story 7.x
  - [x] Integrate with existing role-based navigation from Story 7.3
  - [x] Implement donor authentication and profile management
  - [x] Create donor dashboard with commitment overview
- [x] Create Donor-Specific Backend APIs (AC: 1, 2, 3, 4)
  - [x] Implement /api/v1/donors/commitments endpoints (GET, POST, PUT, DELETE)
  - [x] Add /api/v1/donors/profile endpoint for donor management
  - [x] Create commitment validation and business logic
  - [x] Integrate with existing database schema (Donor, DonorCommitment models)
- [x] Build Donation Commitment Registration Form (AC: 1, 2, 3)
  - [x] Create DonationCommitmentForm component with response type selection
  - [x] Implement item type and quantity specification interface
  - [x] Add delivery timeline planning with date picker
  - [x] Include target affected entity selection
  - [x] Add form validation using Zod schemas
- [x] Implement Commitment Modification Capability (AC: 4)
  - [x] Create commitment editing interface
  - [x] Add commitment status tracking (PLANNED, DELIVERED, CANCELLED)
  - [x] Implement modification history and audit trail
  - [x] Add cancellation functionality with reason codes
- [x] Add comprehensive testing for donation planning (AC: 1, 2, 3, 4)
  - [x] Unit tests for DonationCommitmentForm component and commitment management
  - [x] API route tests for donor endpoints with authentication
  - [x] Integration tests for commitment workflow
  - [x] E2E tests for complete donor registration and commitment flow

## Dev Notes

### Previous Story Insights
Building on completed role management system from Stories 7.1-7.3:
- **Authentication Foundation**: Leverage existing NextAuth.js setup and role-based authentication
- **Role System**: Extend existing DONOR role with specific interface capabilities
- **Permission System**: Build on established permission checking and role validation
- **Navigation Integration**: Use existing role-based navigation system for donor-specific interface

### Data Models
**Donor Management Models** [Source: docs/architecture/8-database-schema.md#donor-models]:
```typescript
export interface Donor {
  id: string; // UUID
  name: string;
  organization: string;
  email: string; // unique
  phone?: string;
  responses: RapidResponse[];
  commitments: DonorCommitment[];
  achievements: DonorAchievement[];
  performanceScore: number; // default 0
  createdAt: Date;
  updatedAt: Date;
}

export interface DonorCommitment {
  id: string; // UUID
  donorId: string;
  donor: Donor;
  responseType: ResponseType; // HEALTH, WASH, SHELTER, FOOD, SECURITY, POPULATION
  quantity: number;
  unit: string;
  targetDate: Date;
  status: string; // PLANNED, DELIVERED, CANCELLED
  createdAt: Date;
  updatedAt: Date;
}
```

**Response Type Integration** [Source: docs/architecture/4-data-models.md#response-types]:
- Use existing ResponseType enum: HEALTH, WASH, SHELTER, FOOD, SECURITY, POPULATION
- Integrate with existing RapidResponse model for donor attribution
- Support both registered donors and typed-in donor names for flexibility

### API Specifications
**Required API Endpoints** [Source: docs/architecture/5-api-specification.md, docs/architecture/8-database-schema.md]:
- POST `/api/v1/donors/register` - Donor profile creation and registration
- GET `/api/v1/donors/profile` - Get current donor profile and statistics
- POST `/api/v1/donors/commitments` - Create new donation commitment
- GET `/api/v1/donors/commitments` - List donor's commitments with filtering
- PUT `/api/v1/donors/commitments/{id}` - Update existing commitment
- DELETE `/api/v1/donors/commitments/{id}` - Cancel commitment

**Authentication Integration** [Source: docs/architecture/7-backend-architecture.md, Story 7.1-7.3 context]:
- Use existing NextAuth.js setup with DONOR role support
- Leverage existing role-based authentication middleware
- Integrate with existing user and session management

### Component Specifications
**Component Architecture** [Source: docs/architecture/6-component-architecture.md, docs/architecture/source-tree.md]:
- Donor dashboard: `packages/frontend/src/app/(dashboard)/donor/page.tsx`
- Commitment form: `packages/frontend/src/components/features/donor/DonationCommitmentForm.tsx`
- Commitment list: `packages/frontend/src/components/features/donor/CommitmentList.tsx`
- Donor profile: `packages/frontend/src/components/features/donor/DonorProfile.tsx`

**Integration with Existing Components** [Source: docs/architecture/6-component-architecture.md]:
- Build on existing component template pattern with explicit props interface
- Follow TypeScript strict mode with form schema definition using Zod
- Integrate with existing offline state handling and auto-save functionality
- Use established error boundaries and loading patterns
- Extend existing role-based navigation from Story 7.3

### File Locations
**Primary Implementation Files** [Source: docs/architecture/source-tree.md]:
- Donor pages: `packages/frontend/src/app/(dashboard)/donor/` directory
- Donor components: `packages/frontend/src/components/features/donor/` directory
- Donor hooks: `packages/frontend/src/hooks/useDonorCommitments.ts`
- Donor store: `packages/frontend/src/stores/donor.store.ts`
- API routes: `packages/frontend/src/app/api/v1/donors/` directory

### Technical Constraints
**Technology Stack** [Source: docs/architecture/2-tech-stack.md]:
- React 18.3.x: Component architecture with donor-specific functionality
- Next.js 14.2.x: App Router for donor dashboard and commitment management
- Zustand 4.5.x: State management for donor commitments and profile data
- React Hook Form 7.51.x: Form handling for commitment registration
- Zod 3.23.x: Schema validation for commitment data
- Prisma 5.14.x: Database ORM with existing Donor and DonorCommitment models
- NextAuth.js 4.24.x: Authentication with DONOR role integration

**String Literal Requirement** [Source: CLAUDE.md#common-error-fixes]:
- Use string literals instead of enums (e.g., 'PLANNED' instead of CommitmentStatus.PLANNED) to avoid Next.js compilation issues in API routes

### Security Considerations
**Data Protection Requirements**:
- Donor personal information (email, phone, organization) requires encryption at rest
- Implement data retention policies: donor data purged after 7 years of inactivity
- GDPR compliance: provide data export and deletion capabilities for donor profiles
- Rate limiting: commitment registration API limited to 10 requests/minute per donor
- Input sanitization: validate and sanitize all donor-provided text fields
- Session management: donor sessions expire after 24 hours of inactivity

### Testing
**Testing Standards** [Source: docs/architecture/14-testing-strategy.md]:
- **Test file naming conventions**: 
  - Components: `packages/frontend/src/__tests__/components/features/donor/DonationCommitmentForm.test.tsx`
  - Hooks: `packages/frontend/src/__tests__/hooks/useDonorCommitments.test.ts`
  - API routes: `packages/frontend/src/__tests__/app/api/v1/donors/commitments/route.test.ts`
  - E2E tests: `packages/frontend/src/e2e/__tests__/story-8.1-donation-planning.e2e.test.ts`
- Testing framework: Jest with React Testing Library for component testing, mocking stores and authentication
- Mock dependencies: NextAuth.js session management, Prisma database operations, API endpoints
- Test coverage requirements: commitment form validation, donor authentication, commitment CRUD operations

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-02 | 1.0 | Initial story creation for Donation Planning | Bob (SM) |
| 2025-09-02 | 1.1 | Enhanced AC specificity, resequenced tasks, added security requirements | Sarah (PO) |
| 2025-09-02 | 2.0 | Implementation completed - all acceptance criteria met | Claude (Dev Agent) |

## Dev Agent Record

### Implementation Summary
**Date**: 2025-09-02  
**Agent**: Claude (Dev Agent)  
**Status**: ✅ Completed

### Components Implemented
- **Donor Dashboard**: `/app/(dashboard)/donor/page.tsx` - Tabbed interface with commitments, new commitment form, and profile
- **Donation Commitment Form**: `DonationCommitmentForm.tsx` - Complete form with response type selection, validation, and auto-save
- **Commitment Management**: `CommitmentList.tsx` - List, filter, search, edit, and cancel commitments
- **Donor Profile**: `DonorProfile.tsx` - Profile viewing/editing with performance metrics
- **Zustand Store**: `donor.store.ts` - State management for commitments and profile data

### API Endpoints Implemented
- **POST** `/api/v1/donors/commitments` - Create new commitments with validation
- **PUT/DELETE** `/api/v1/donors/[id]/commitments/route.ts` - Update/cancel existing commitments
- **GET/PUT** `/api/v1/donors/profile/route.ts` - Donor profile management

### Key Technical Features
- ✅ React Hook Form with Zod schema validation
- ✅ Quantity range validation (1-999,999) and 50-character unit limit
- ✅ Future date validation (minimum tomorrow, maximum 365 days)
- ✅ Auto-save functionality with localStorage persistence
- ✅ Unit suggestions based on response type selection
- ✅ Comprehensive error handling and loading states
- ✅ TypeScript strict mode compliance

### Testing Implementation
- ✅ Unit tests for all components and store functions
- ✅ API route tests with validation scenarios
- ✅ E2E tests covering complete user workflows
- ✅ Form validation edge cases and business rule testing

### Quality Assurance
- ✅ ESLint compliance (fixed missing Package icon import)
- ✅ TypeScript compilation validation
- ✅ Offline-first architecture with graceful degradation
- ✅ Accessibility considerations and keyboard navigation

### Files Created/Modified
```
packages/frontend/src/
├── app/(dashboard)/donor/page.tsx
├── components/features/donor/
│   ├── DonationCommitmentForm.tsx
│   ├── CommitmentList.tsx
│   └── DonorProfile.tsx
├── stores/donor.store.ts
├── app/api/v1/donors/
│   ├── [id]/commitments/route.ts
│   └── profile/route.ts
├── __tests__/
│   ├── components/features/donor/
│   ├── stores/donor.store.test.ts
│   └── app/api/v1/donors/
└── e2e/__tests__/story-8.1-donation-planning.e2e.test.ts
```

## QA Results
*This section will be populated by the QA agent after testing*