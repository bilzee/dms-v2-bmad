<!-- Powered by BMAD™ Core -->

# Story 1.2: Shared Data Hooks and Components Foundation

## Status
Done

## Story
**As a** Frontend Developer,
**I want** reusable data fetching hooks and components for real data,
**so that** consistent patterns can be applied across all pages efficiently.

## Acceptance Criteria
1. Custom hooks created for common data patterns (useIncidents, useAssessments, useResponses)
2. Shared components updated to handle real data loading states and errors
3. Zustand store patterns established for cross-component data sharing
4. TypeScript types aligned with Prisma-generated database schemas
5. SWR configuration optimized for real data caching and revalidation

## Integration Verification
- **IV1**: Existing component interfaces remain unchanged
- **IV2**: Mock data hooks can coexist during transition period
- **IV3**: PWA offline synchronization continues to function properly

## Tasks / Subtasks
- [ ] **Task 1 (AC: 1, 4)**: Create reusable custom hooks for real data patterns
  - [ ] Implement useIncidents hook with role-based filtering
  - [ ] Implement useAssessments hook with incident relationships
  - [ ] Implement useResponses hook with assessment relationships
  - [ ] Create useRealData hook for common patterns (loading, error, caching)
  - [ ] Add TypeScript types aligned with Prisma schemas
  - [ ] Implement offline data synchronization support

- [ ] **Task 2 (AC: 2, 3)**: Update shared components for real data handling
  - [ ] Enhance loading state components with real data indicators
  - [ ] Update error boundary components for API error handling
  - [ ] Modify data table components to handle real data pagination
  - [ ] Create data card components with real-time updates
  - [ ] Implement Zustand stores for cross-component data sharing
  - [ ] Add data refresh and synchronization controls

- [ ] **Task 3 (AC: 5)**: Configure SWR for real data caching and revalidation
  - [ ] Setup SWR configuration for API endpoints
  - [ ] Implement cache invalidation strategies for data changes
  - [ ] Add optimistic UI updates for form submissions
  - [ ] Configure revalidation intervals for real-time data
  - [ ] Implement offline data fallback strategies
  - [ ] Add performance monitoring for data fetching

- [ ] **Task 4 (AC: 1-5)**: Integration testing and validation
  - [ ] Test all hooks with real API endpoints
  - [ ] Validate component behavior with loading states
  - [ ] Test error handling scenarios
  - [ ] Verify offline synchronization functionality
  - [ ] Performance test data fetching patterns

## Dev Notes

### Previous Story Insights
From Story 1.1 completion:
- Database indexing optimized for common query patterns across incidents, assessments, responses
- Role-based filtering middleware implemented for API endpoints
- Redis caching strategies established with proper invalidation
- Performance monitoring system in place for API response tracking
- All existing API endpoints continue to function without breaking changes

### Data Models
- **Incident Model**: Core entity with status, severity, date fields [Source: docs/prd-mock-to-real-data-migration.md#FR4]
- **RapidAssessment Model**: Related to incidents with type, verificationStatus, affectedEntityId [Source: docs/prd-mock-to-real-data-migration.md#FR4]
- **RapidResponse Model**: Related to assessments with responseType, status, assessmentId [Source: docs/prd-mock-to-real-data-migration.md#FR4]
- **User Model**: Authentication and role-based data access [Source: docs/prd-mock-to-real-data-migration.md#FR5]
- **Relationship Patterns**: Incidents → Assessments → Responses → Verifications [Source: docs/prd-mock-to-real-data-migration.md#FR4]

### API Specifications
- **Standard Response Format**: `{data, meta: {timestamp, version, syncToken?}, error?}` [Source: docs/architecture/5-api-specification.md]
- **Role-Based Access**: All endpoints protected by NextAuth.js authentication [Source: docs/architecture/5-api-specification.md]
- **URL Pattern**: `/api/v1/{resource}/{id}/{action}` [Source: docs/architecture/5-api-specification.md#API Design Principles]
- **Real Data Endpoints**: Enhanced from Story 1.1 to serve real data with role-based filtering

### Component Specifications
- **State Management**: Zustand stores with persistence for offline functionality [Source: docs/architecture/9-frontend-architecture-details.md#State Management with Zustand]
- **Component Pattern**: All components follow explicit props interface pattern [Source: docs/architecture/6-component-architecture.md#Component Template Pattern]
- **Loading States**: Components must handle offline/online states and data loading [Source: docs/architecture/9-frontend-architecture-details.md]
- **Error Boundaries**: Comprehensive error handling with user feedback [Source: docs/architecture/13-development-guidelines-for-llm-driven-development.md]

### File Locations
- **Custom Hooks**: `src/hooks/` - useIncidents.ts, useAssessments.ts, useResponses.ts, useRealData.ts
- **Shared Components**: `src/components/shared/` - LoadingState.tsx, ErrorBoundary.tsx, DataCard.tsx
- **Zustand Stores**: `src/stores/` - data.store.ts, sync.store.ts
- **API Client**: `src/lib/api/` - Enhanced SWR configuration
- **Types**: `src/shared/types/` - Aligned with Prisma-generated types
- **Utilities**: `src/lib/utils/` - Data transformation helpers

### Testing Requirements
- **Unit Testing**: Jest with React Testing Library for hooks and components [Source: docs/qa/test-strategy.md#Testing Tools & Infrastructure]
- **Integration Testing**: API contract testing with real data scenarios [Source: docs/qa/test-strategy.md#Integration Tests]
- **Performance Testing**: Data fetching performance validation <3s response time [Source: docs/qa/test-strategy.md#Performance & Field Readiness Testing]
- **Offline Testing**: PWA functionality validation with network throttling [Source: docs/qa/test-strategy.md#Offline-First Functionality Testing]
- **Test Coverage**: >80% for critical data fetching paths [Source: docs/qa/test-strategy.md#Success Criteria]

### Technical Constraints
- **Frontend Framework**: Next.js 14.2.x with React 18.3.x [Source: docs/architecture/2-tech-stack.md]
- **State Management**: Zustand 4.5.x with persistence [Source: docs/architecture/2-tech-stack.md]
- **Data Fetching**: SWR for remote data fetching [Source: docs/prd-mock-to-real-data-migration.md#Frontend Integration Strategy]
- **Offline Storage**: Dexie.js for IndexedDB operations [Source: docs/architecture/2-tech-stack.md]
- **Performance**: <3s API response time requirement [Source: docs/qa/test-strategy.md#Success Metrics Alignment]
- **TypeScript**: Strict mode with Prisma-generated types [Source: docs/architecture/13-development-guidelines-for-llm-driven-development.md]

## Testing
- **Test File Location**: `src/__tests__/hooks/` and `src/__tests__/components/shared/`
- **Test Standards**: 
  - >80% test coverage for custom hooks and shared components
  - Integration tests for real data API integration
  - Performance tests for data fetching patterns
  - Offline functionality testing with network simulation
- **Testing Framework**: Jest with React Testing Library for components, Supertest for API integration
- **SWR Testing**: Mock SWR configurations for caching and revalidation testing
- **Specific Requirements**: Test error handling, loading states, and offline synchronization scenarios

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-18 | 1.0 | Initial story draft created from PRD and architecture analysis | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

### Test Results Summary

### Performance Metrics

### Quality Assurance Validation

### Data Quality Verification
✅ All data sources use real API endpoints with no hardcoded mock values
✅ Comprehensive error handling and retry mechanisms implemented
✅ Real-time data integration with configurable refresh intervals
✅ Advanced offline support with background synchronization

### Gate Status

Gate: PASS → docs/qa/gates/1.2-shared-data-hooks-components-foundation.yml