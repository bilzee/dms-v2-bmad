# Story 3.4: Automatic Approval Configuration

## Parent Epic
**Epic 3: Coordinator Verification Workflow** - CV-004: Automatic Approval Configuration [Source: docs/prd/user-stories-epics.md:130-137]

## Status
Done

## Story
**As a** Coordinator **I want to** configure automatic approval rules **so that** I can prevent bottlenecks during high-volume periods while maintaining oversight

## Acceptance Criteria
1. Configurable auto-approval rules by assessment type
2. Quality thresholds for automatic approval  
3. Override capability for manual review
4. Clear visual indicators for auto-approved data

## Tasks / Subtasks
- [ ] Create AutoApprovalConfiguration component for rule management (AC: 1, 2)
  - [ ] Build configuration form for assessment type rules (HEALTH, WASH, SHELTER, FOOD, SECURITY, POPULATION)
  - [ ] Build configuration form for response type rules (same types)
  - [ ] Add quality threshold settings per type (completeness score, required fields, etc.)
  - [ ] Implement rule priority and conflict resolution settings
  - [ ] Add validation for configuration values and thresholds
- [ ] Develop QualityThresholdSettings component for advanced criteria (AC: 2)
  - [ ] Create data completeness percentage thresholds
  - [ ] Add required field validation rules configuration
  - [ ] Build assessor/responder reputation score thresholds
  - [ ] Implement time-based approval windows configuration
  - [ ] Add batch size limits and processing intervals
- [ ] Create AutoApprovalOverride component for manual intervention (AC: 3)
  - [ ] Build override interface for auto-approved items
  - [ ] Implement bulk override capability for emergencies
  - [ ] Add override reason codes and documentation
  - [ ] Create override audit trail and notifications
  - [ ] Support reverting auto-approvals to manual review
- [ ] Implement AutoApprovalIndicators component for visual feedback (AC: 4)
  - [ ] Add auto-approval status badges and icons
  - [ ] Create visual distinction between manual and auto-approved items
  - [ ] Build auto-approval statistics dashboard
  - [ ] Add filtering and sorting by approval method
  - [ ] Implement auto-approval performance metrics display
- [ ] Add API endpoints and data management (AC: 1, 2, 3, 4)
  - [ ] Create **POST/PUT** `/api/v1/config/auto-approval/rules` endpoint
  - [ ] Add **GET** `/api/v1/config/auto-approval/rules` endpoint
  - [ ] Implement **POST** `/api/v1/verification/auto-approve/override` endpoint
  - [ ] Create **GET** `/api/v1/verification/auto-approval/stats` endpoint
  - [ ] Add **POST** `/api/v1/verification/auto-approval/test` endpoint for rule testing
  - [ ] Implement auto-approval processing engine with rule evaluation
- [ ] Implement comprehensive testing (AC: 1, 2, 3, 4)
  - [ ] Unit tests for configuration components and rule validation
  - [ ] Integration tests for auto-approval processing engine
  - [ ] Testing for threshold evaluation and edge cases
  - [ ] End-to-end tests for complete auto-approval workflow

## Dev Notes

### Previous Story Insights
Building on Stories 3.1-3.3 completion (Assessment/Response Verification workflows):
- Verification queues established with AssessmentVerificationQueue and ResponseVerificationQueue
- Manual approval/rejection patterns proven with AssessmentApproval/AssessmentRejection and ResponseApproval/ResponseRejection
- VerificationStatus enum already supports AUTO_VERIFIED status
- Feedback system established for both assessments and responses with targetType distinction
- Coordinator workflows and permissions patterns established

### Data Models
**VerificationStatus Enum** [Source: packages/shared/types/entities.ts:123-128]:
```typescript
export enum VerificationStatus {
  PENDING = 'PENDING',
  VERIFIED = 'VERIFIED',
  AUTO_VERIFIED = 'AUTO_VERIFIED', // Already defined for auto-approval
  REJECTED = 'REJECTED'
}
```

**NEW: Auto-Approval Configuration Data Structures**:
```typescript
// Auto-Approval Rule Configuration
export interface AutoApprovalRule {
  id: string;
  type: 'ASSESSMENT' | 'RESPONSE';
  assessmentType?: AssessmentType; // HEALTH, WASH, SHELTER, FOOD, SECURITY, POPULATION
  responseType?: ResponseType; // Same types as assessment
  enabled: boolean;
  qualityThresholds: QualityThreshold;
  conditions: AutoApprovalCondition[];
  priority: number; // For rule conflict resolution
  createdBy: string;
  createdAt: Date;
  updatedAt: Date;
}

// Quality thresholds for auto-approval eligibility
export interface QualityThreshold {
  dataCompletenessPercentage: number; // 80-100%
  requiredFieldsComplete: boolean;
  hasMediaAttachments?: boolean;
  gpsAccuracyMeters?: number;
  assessorReputationScore?: number; // If reputation system exists
  timeSinceSubmission?: number; // Minutes
  maxBatchSize?: number;
}

// Conditions for auto-approval
export interface AutoApprovalCondition {
  field: string; // Field path in assessment/response data
  operator: 'equals' | 'not_equals' | 'greater_than' | 'less_than' | 'contains' | 'exists';
  value: any;
  weight: number; // Importance weight 1-10
}

// Configuration settings
export interface AutoApprovalConfig {
  enabled: boolean;
  rules: AutoApprovalRule[];
  globalSettings: {
    maxAutoApprovalsPerHour: number;
    requireCoordinatorOnline: boolean;
    emergencyOverrideEnabled: boolean;
    auditLogRetentionDays: number;
  };
  coordinatorId: string;
  lastUpdated: Date;
}

// Override tracking
export interface AutoApprovalOverride {
  id: string;
  targetType: 'ASSESSMENT' | 'RESPONSE';
  targetId: string;
  originalStatus: VerificationStatus;
  newStatus: VerificationStatus;
  reason: 'EMERGENCY_OVERRIDE' | 'QUALITY_CONCERN' | 'POLICY_CHANGE' | 'OTHER';
  reasonDetails: string;
  coordinatorId: string;
  coordinatorName: string;
  overriddenAt: Date;
  ruleId?: string; // Which rule was overridden
}
```

### API Specifications
**Auto-Approval Configuration Endpoints**:
- **POST/PUT** `/api/v1/config/auto-approval/rules` - Create/update auto-approval rules
- **GET** `/api/v1/config/auto-approval/rules` - Get current auto-approval configuration
- **POST** `/api/v1/verification/auto-approve/override` - Override auto-approved items
- **GET** `/api/v1/verification/auto-approval/stats` - Get auto-approval statistics
- **POST** `/api/v1/verification/auto-approval/test` - Test auto-approval rules against sample data

**Auto-Approval Processing Engine**:
```typescript
// POST /api/v1/config/auto-approval/rules
interface AutoApprovalRulesRequest {
  rules: AutoApprovalRule[];
  globalSettings: AutoApprovalConfig['globalSettings'];
}

interface AutoApprovalRulesResponse extends ApiResponse<{
  rulesCreated: number;
  rulesUpdated: number;
  configId: string;
  validationErrors?: string[];
}> {}

// POST /api/v1/verification/auto-approve/override
interface AutoApprovalOverrideRequest {
  targetType: 'ASSESSMENT' | 'RESPONSE';
  targetIds: string[];
  newStatus: 'PENDING' | 'REJECTED';
  reason: string;
  reasonDetails: string;
  coordinatorId: string;
}

// GET /api/v1/verification/auto-approval/stats
interface AutoApprovalStatsResponse extends ApiResponse<{
  totalAutoApproved: number;
  autoApprovalRate: number; // Percentage
  averageProcessingTime: number; // Seconds
  rulePerformance: {
    ruleId: string;
    applicationsCount: number;
    successRate: number;
  }[];
  overridesCount: number;
  timeRange: string;
}> {}
```

### Component Specifications
**Component Architecture** [Source: docs/architecture/source-tree.md - Frontend Organization section]:
- AutoApprovalConfiguration: `components/features/verification/AutoApprovalConfiguration.tsx`
- QualityThresholdSettings: `components/features/verification/QualityThresholdSettings.tsx`
- AutoApprovalOverride: `components/features/verification/AutoApprovalOverride.tsx`
- AutoApprovalIndicators: `components/features/verification/AutoApprovalIndicators.tsx`

**UI/UX Design Specifications**:
- **Configuration Interface**: Tabbed interface with assessment/response type rules
- **Quality Thresholds**: Slider inputs for percentages, toggles for boolean conditions
- **Override Interface**: Emergency override panel with reason selection and bulk actions
- **Visual Indicators**: Badge system with colors (Green: AUTO_VERIFIED, Blue: VERIFIED, Yellow: PENDING, Red: REJECTED)
- **Statistics Dashboard**: Real-time metrics with charts showing auto-approval performance
- **Rule Testing**: Preview mode to test rules against historical data

### File Locations
**Primary Implementation Files**:
- Auto-approval configuration: `packages/frontend/src/components/features/verification/AutoApprovalConfiguration.tsx`
- Quality threshold settings: `packages/frontend/src/components/features/verification/QualityThresholdSettings.tsx`
- Override management: `packages/frontend/src/components/features/verification/AutoApprovalOverride.tsx`
- Visual indicators: `packages/frontend/src/components/features/verification/AutoApprovalIndicators.tsx`

**Integration Files**:
- Configuration API endpoints: `packages/frontend/src/app/api/v1/config/auto-approval/rules/route.ts`
- Override API endpoint: `packages/frontend/src/app/api/v1/verification/auto-approve/override/route.ts`
- Statistics API endpoint: `packages/frontend/src/app/api/v1/verification/auto-approval/stats/route.ts`
- Test API endpoint: `packages/frontend/src/app/api/v1/verification/auto-approval/test/route.ts`

**Store Integration**:
- Extend verification store: `packages/frontend/src/stores/verification.store.ts` with auto-approval configuration state
- Add configuration persistence with localStorage/IndexedDB for offline scenarios

### Testing Requirements
**Testing Strategy** [Source: docs/architecture/14-testing-strategy.md]:
- Test file pattern: `__tests__/components/features/verification/AutoApprovalConfiguration.test.tsx`
- Mock auto-approval API endpoints and configuration services
- Test rule creation, validation, and conflict resolution
- Test quality threshold evaluation with edge cases
- Test override functionality and audit trails
- Test visual indicator rendering and statistics display

### Database/Storage Architecture
**Database Schema** [Source: docs/architecture/8-database-schema.md]:
- New AutoApprovalRule table for rule configuration storage
- New AutoApprovalOverride table for override tracking and audit trails
- Extend Verification table with auto-approval metadata (ruleId, processingTime)
- New AutoApprovalStats table for performance metrics tracking

**Offline Storage Extensions** [Dexie.js Schema]:
```typescript
// EXTEND: packages/frontend/src/lib/offline/db.ts
interface OfflineSchema {
  // ... existing tables
  autoApprovalConfig: {
    id: string;
    rules: AutoApprovalRule[];
    globalSettings: AutoApprovalConfig['globalSettings'];
    lastSynced: Date;
  };
  autoApprovalOverrides: {
    overrideId: string;
    targetType: 'ASSESSMENT' | 'RESPONSE';
    targetId: string;
    coordinatorId: string;
    reason: string;
    queuedAt: Date;
    syncStatus: 'PENDING' | 'SYNCED';
  };
}
```

### Technical Constraints
**Technology Stack** [Source: docs/architecture/2-tech-stack.md]:
- Frontend: Next.js 14.2.x, React 18.3.x, Zustand 4.5.x for state management
- Forms: React Hook Form 7.51.x with Zod 3.23.x for validation
- UI: Shadcn/ui components with Tailwind CSS for consistent styling
- Offline: Dexie.js 4.0.x for IndexedDB configuration persistence
- Data visualization: Chart.js or Recharts for auto-approval statistics

**Performance Considerations**:
- Efficient rule evaluation engine with caching for repeated assessments
- Batch processing to prevent overwhelming coordinators with auto-approvals
- Background processing for rule evaluation without blocking UI
- Configurable processing intervals to balance performance and real-time needs

**Error Handling and Recovery Mechanisms**:
- **Rule Evaluation Failures**: 
  - Malformed rule conditions should fallback to manual review
  - Log detailed error context for debugging rule logic
  - Graceful degradation when rule evaluation service is unavailable
- **API Endpoint Error Conditions**:
  - Configuration save failures: Preserve previous working configuration
  - Rule conflict detection: Present conflict resolution options to coordinator
  - Invalid threshold values: Provide clear validation messages with acceptable ranges
- **Override System Failures**:
  - Network disconnection during override: Queue override requests for sync
  - Permission validation failures: Clear messaging about role requirements
  - Bulk override failures: Partial success handling with detailed failure reports
- **Background Processing Errors**:
  - Auto-approval engine crashes: Automatic restart with exponential backoff
  - Database connection issues: Retry logic with circuit breaker pattern
  - Memory exhaustion: Batch size reduction and garbage collection triggers
- **Configuration Corruption Recovery**:
  - Invalid configuration detection on startup: Revert to last known good state
  - Conflicting rule priority resolution: Automatic priority rebalancing
  - Missing required fields: Default value assignment with coordinator notification

**Security Considerations**:
- Auto-approval rule changes require audit trail for accountability
- Configuration changes require proper coordinator role validation
- Override actions require elevated permissions and justification
- Quality threshold manipulation protection against abuse
- Secure rule evaluation to prevent injection attacks in conditions

### Testing
**Testing Standards** [Source: docs/architecture/14-testing-strategy.md]:
- Test file location: `__tests__/components/features/verification/AutoApprovalConfiguration.test.tsx`
- Testing framework: Jest with React Testing Library for component testing
- Mock external dependencies: configuration API endpoints, rule evaluation engine
- Test coverage requirements: rule creation/validation, threshold evaluation, override functionality, visual indicators

**Auto-Approval Engine Testing Scenarios**:
- **Rule Evaluation**: Test rule matching with various data combinations and edge cases
- **Quality Threshold Testing**: Validate percentage calculations, required field checks, GPS accuracy
- **Conflict Resolution**: Test rule priority handling when multiple rules could apply
- **Performance Testing**: 
  - Process 100 items in queue: <5 seconds
  - Process 500 items in queue: <15 seconds  
  - Process 1000+ items in queue: <30 seconds
  - Memory usage stays under 100MB during batch processing
  - CPU usage peaks under 80% during rule evaluation
  - Database query response times under 200ms for rule retrieval
- **Override Testing**: Verify override functionality preserves audit trails and notifications
- **Statistics Testing**: Validate metrics calculations for auto-approval performance
- **Configuration Persistence**: Test offline configuration storage and sync recovery

## QA Results
*This section will be populated by the QA agent after implementation*

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-25 | 1.0 | Initial story creation for Automatic Approval Configuration | Bob (SM) |
| 2025-08-25 | 1.1 | Added enhanced performance benchmarks, comprehensive error handling, and verified architecture references | Sarah (PO) |