# Story 1.3: Center Panel - Assessment Area Breakdown with Gap Analysis

## Parent Epic
**Epic 1: Analytics Dashboard Enhancement** - Story 1.3: Center Panel - Assessment Area Breakdown with Gap Analysis [Source: docs/prd/analytics-dashboard-enhancement.md#story-13-center-panel---assessment-area-breakdown-with-gap-analysis]

## Status
Ready for Review

## Story
**As a** Coordinator,
**I want** to view detailed assessment areas (Health, WASH, Food, Shelter, Security) with latest assessments and gap analysis side-by-side for selected entities,
**so that** I can analyze specific needs and response gaps for each critical area.

## Acceptance Criteria
1. Affected entity dropdown filters based on selected incident from left panel
2. Assessment area breakdown shows each area (Health, WASH, Food, Shelter, Security, etc.) with:
   - Latest assessment data with timestamp on the left
   - Gap analysis (latest response vs latest assessment) on the right
3. **Space management**: If all assessment areas don't fit with interactive map below, implement selection mechanism to choose which areas to display
4. Loading states displayed during cross-panel data fetching
5. Clear visual distinction between assessment data and gap analysis columns

## Tasks / Subtasks

- [x] **Task 1: Implement Entity Selection Dropdown** (AC: 1, 4)
  - [x] Create entity dropdown component using shadcn/ui Select
  - [x] Connect to new API endpoint `/api/v1/monitoring/analytics/entities/by-incident/{id}`
  - [x] Filter entities based on selected incident from analytics store
  - [x] Include "All Affected Entities" option plus individual entities
  - [x] Implement loading states during entity data fetching

- [x] **Task 2: Build Assessment Area Breakdown Component** (AC: 2, 5)
  - [x] Create AssessmentAreaBreakdown component with dual-column layout
  - [x] Display assessment areas (Health, WASH, Food, Shelter, Security)
  - [x] Left column: Latest assessment data with timestamp
  - [x] Right column: Gap analysis with clear visual distinction
  - [x] Connect to `/api/v1/monitoring/analytics/assessments/breakdown` endpoint

- [x] **Task 3: Implement Gap Analysis Display** (AC: 2)
  - [x] Create GapAnalysisView component for response gap calculations
  - [x] Display boolean gap indicators (responseGap: true/false)
  - [x] Show severity classifications when available (HIGH/MEDIUM/LOW)
  - [x] Implement color-coding: Red (critical), Yellow (moderate), Green (minimal)
  - [x] Format unmet needs percentages and response timestamps

- [x] **Task 4: Create Space Management System** (AC: 3)
  - [x] Implement assessment area selection mechanism
  - [x] Calculate available space with interactive map below
  - [x] Provide UI controls to select which areas to display
  - [x] Ensure all areas accessible even with space constraints

- [x] **Task 5: Enhance CenterPanel Integration** (AC: 1, 4)
  - [x] Update CenterPanel.tsx to include entity selection and assessment breakdown
  - [x] Integrate with analytics store for cross-panel communication
  - [x] Subscribe to selectedIncident changes from left panel
  - [x] Implement proper loading states and error handling

- [x] **Task 6: Create Assessment Breakdown API Endpoint** (AC: 2)
  - [x] Create `/api/v1/monitoring/analytics/assessments/breakdown` route
  - [x] Aggregate assessment and response data by area
  - [x] Calculate gap analysis using existing assessment-to-response logic
  - [x] Follow established API patterns and authentication
  - [x] Return structured assessment area data with timestamps

- [x] **Task 7: Create Entity Filter API Endpoint** (AC: 1)
  - [x] Create `/api/v1/monitoring/analytics/entities/by-incident/{id}` route
  - [x] Filter entities by incident relationships using existing data models
  - [x] Include "All Affected Entities" aggregate option
  - [x] Return entity list with coordinates for map integration
  - [x] Follow established API response patterns

## Dev Notes

### Previous Story Context
**Story 1.2 Completion:** Left panel incident selection successfully implemented with analytics store managing cross-panel state. Analytics store provides `selectedIncident` state that center panel components can subscribe to for incident-based filtering.

### Architecture Context
[Source: docs/architecture/analytics-dashboard-enhancement-architecture.md#component-architecture]

**Technology Stack:**
- React 18.3.x with functional components and hooks for center panel components
- Zustand 4.5.x analytics store for cross-panel state management (existing `analytics.store.ts`)
- React Hook Form 7.51.x for entity dropdown selection controls
- shadcn/ui Select, Card, Badge components for UI consistency
- Zod 3.23.x for API response validation of assessment and entity data

**Component Architecture:**
- **CenterPanel**: Enhanced to include entity selection and assessment breakdown display
- **AssessmentAreaBreakdown**: New component for dual-column assessment/gap display
- **GapAnalysisView**: New component for response gap calculations and color-coding
- **EntitySelector**: New component for incident-filtered entity selection

### File Locations
[Source: docs/architecture/analytics-dashboard-enhancement-architecture.md#source-tree-integration]

**Files to Modify:**
```
packages/frontend/src/components/features/analytics/
├── CenterPanel.tsx                               # Enhanced from placeholder
├── AssessmentAreaBreakdown.tsx                  # New component
├── GapAnalysisView.tsx                          # New component
├── EntitySelector.tsx                           # New component
└── __tests__/
    ├── CenterPanel.test.tsx                     # Enhanced tests
    ├── AssessmentAreaBreakdown.test.tsx         # New tests  
    ├── GapAnalysisView.test.tsx                 # New tests
    └── EntitySelector.test.tsx                  # New tests
```

**New Files to Create:**
```
packages/frontend/src/app/api/v1/monitoring/analytics/
├── assessments/breakdown/route.ts               # Assessment breakdown endpoint
└── entities/by-incident/[id]/route.ts           # Entity filtering endpoint
```

### Technical Constraints
[Source: docs/architecture/analytics-dashboard-enhancement-architecture.md#api-design-and-integration]

**API Integration Rules:**
- Must consume existing assessment and entity data without schema modifications
- New analytics endpoints aggregate existing data using established Prisma models
- Follow existing API response patterns and NextAuth.js authentication
- Gap analysis uses established assessment-to-response comparison logic

**Performance Requirements:**
- Entity selection must trigger efficient cross-panel state updates
- Assessment area loading should not block UI interaction
- Space management calculations must be responsive for different screen sizes
- Maintain existing 25-second refresh patterns for real-time updates

**Cross-Panel Communication Pattern:**
```typescript
// Analytics store integration for center panel
const { selectedIncident, setSelectedEntity } = useAnalyticsStore();
const [filteredEntities, setFilteredEntities] = useState([]);

// Entity filtering based on incident selection
useEffect(() => {
  if (selectedIncident) {
    fetchEntitiesByIncident(selectedIncident.id);
  }
}, [selectedIncident]);
```

### Data Models
[Source: docs/architecture/analytics-dashboard-enhancement-architecture.md#api-design-and-integration]

**API Response Structure for Assessment Breakdown:**
```typescript
interface AssessmentBreakdownResponse {
  success: true;
  data: {
    assessmentAreas: [
      {
        area: "Health" | "WASH" | "Food" | "Shelter" | "Security";
        latestAssessment: {
          timestamp: string;
          severity: "CRITICAL" | "HIGH" | "MEDIUM" | "LOW";
          details: string;
        };
        gapAnalysis: {
          responseGap: boolean;
          unmetNeeds: number;
          responseTimestamp: string;
          gapSeverity: "HIGH" | "MEDIUM" | "LOW";
        };
      }
    ];
  };
}
```

**Entity Filter Response Structure:**
```typescript
interface EntityFilterResponse {
  success: true;
  data: {
    entities: [
      {
        id: "all" | string;
        name: string;
        type: "aggregate" | "LGA" | "Ward" | "Community";
        coordinates?: [number, number];
      }
    ];
    totalCount: number;
  };
}
```

### API Specifications

**New Endpoint 1:** `GET /api/v1/monitoring/analytics/assessments/breakdown`
- **Purpose:** Assessment area breakdown with gap analysis for center panel display
- **Request Parameters:** incidentId, entityId (or "all"), assessmentAreas array
- **Integration:** Combines existing assessment and response data using Prisma models
- **Authentication:** NextAuth.js session validation

**New Endpoint 2:** `GET /api/v1/monitoring/analytics/entities/by-incident/{id}`
- **Purpose:** Filtered entity list based on incident for center panel dropdown
- **Request Parameters:** incidentId, includeAll flag
- **Integration:** Filters existing entity data by incident relationships
- **Authentication:** NextAuth.js session validation

### Gap Analysis Implementation
[Source: docs/architecture/analytics-dashboard-enhancement-architecture.md#gap-analysis-data-structure]

**Core Approach:**
- **Boolean Foundation**: `responseGap: true/false` as primary indicator from assessment questions
- **Optional Severity**: `gapSeverity: "HIGH" | "MEDIUM" | "LOW"` when numeric data available
- **Color-Coded Display**: Red (critical gaps), Yellow (moderate gaps), Green (minimal/no gaps)
- **Flexible Support**: System handles both boolean-only and severity-classified gaps

**Color-Coding Logic:**
- Boolean-only: `responseGap: true` → Red, `responseGap: false` → Green
- With severity: HIGH → Red, MEDIUM → Yellow, LOW → Green
- Fallback: Use boolean when severity calculation unavailable

### Security Considerations
[Source: docs/architecture/analytics-dashboard-enhancement-architecture.md#infrastructure-and-deployment-integration]

**Authentication & Authorization:**
- Center panel inherits existing NextAuth.js middleware protection
- Entity and assessment data accessed through existing secure API patterns
- No additional role-based filtering required (accessible to all system users per PRD)

**Data Security:**
- API endpoints follow established authentication patterns from existing monitoring APIs
- Assessment and entity data accessed through existing secure Prisma models
- No sensitive data exposure in client-side analytics store

### Testing
[Source: docs/architecture/analytics-dashboard-enhancement-architecture.md#coding-standards-and-conventions]

**Test Framework:** Jest with React Testing Library + Playwright for E2E

**Test File Locations:**
```
packages/frontend/src/components/features/analytics/__tests__/
├── CenterPanel.test.tsx                     # Enhanced tests
├── AssessmentAreaBreakdown.test.tsx         # New tests  
├── GapAnalysisView.test.tsx                 # New tests
├── EntitySelector.test.tsx                  # New tests
└── analytics.store.test.ts                  # Store tests for new functionality
```

**Test Requirements:**
- Entity dropdown population and incident-based filtering
- Assessment area breakdown data display and formatting
- Gap analysis calculations and color-coding accuracy
- Cross-panel state communication (incident → entity filtering)
- Space management mechanism functionality
- API endpoint integration and error handling
- Loading states and responsive behavior

**Test Scenarios:**
- Entity selection triggers assessment area updates
- Assessment breakdown displays correctly for different entity types
- Gap analysis shows appropriate color-coding based on severity
- Space management adapts to different screen sizes
- Loading states display during cross-panel data fetching
- Error handling for missing assessment or entity data
- Cross-panel communication maintains state consistency

## Integration Verification
[Source: docs/prd/analytics-dashboard-enhancement.md#story-13]

**IV1**: Assessment area data structures remain compatible with existing assessment workflows
**IV2**: Gap analysis calculations align with existing response-to-assessment comparison logic  
**IV3**: Assessment area filtering doesn't interfere with existing data validation patterns

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-14 | 1.0 | Initial story creation for center panel assessment breakdown | SM Agent (Sequential Thinking) |

## Dev Agent Record

### Agent Model Used
Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Frontend build validation: pnpm build completed successfully with only pre-existing image optimization warnings
- Linting validation: ESLint passed with only pre-existing warnings unrelated to new implementation
- Type validation: Components compiled successfully through Next.js build process

### Completion Notes List
1. **Entity Selection**: Implemented EntitySelector component with full integration to analytics store and incident-based filtering
2. **Assessment Breakdown**: Created comprehensive AssessmentAreaBreakdown component with dual-column layout for assessment data and gap analysis
3. **Gap Analysis**: Developed GapAnalysisView component with boolean/severity-based gap detection, color coding, and detailed explanations
4. **Space Management**: Built AreaSelectionManager component with dynamic space calculation and responsive area selection controls
5. **API Integration**: Created both required API endpoints with proper error handling, authentication, and data aggregation
6. **Testing Coverage**: Implemented comprehensive unit tests for all new components covering functionality, error states, and user interactions
7. **Cross-Panel Communication**: Enhanced CenterPanel with full analytics store integration and incident-based state management

### File List

**New Components Created:**
- packages/frontend/src/components/features/analytics/EntitySelector.tsx
- packages/frontend/src/components/features/analytics/AssessmentAreaBreakdown.tsx  
- packages/frontend/src/components/features/analytics/GapAnalysisView.tsx
- packages/frontend/src/components/features/analytics/AreaSelectionManager.tsx

**Enhanced Components:**
- packages/frontend/src/components/features/analytics/CenterPanel.tsx

**New API Endpoints:**
- packages/frontend/src/app/api/v1/monitoring/analytics/entities/by-incident/[id]/route.ts
- packages/frontend/src/app/api/v1/monitoring/analytics/assessments/breakdown/route.ts

**Test Files Created:**
- packages/frontend/src/components/features/analytics/__tests__/EntitySelector.test.tsx
- packages/frontend/src/components/features/analytics/__tests__/AssessmentAreaBreakdown.test.tsx
- packages/frontend/src/components/features/analytics/__tests__/GapAnalysisView.test.tsx
- packages/frontend/src/components/features/analytics/__tests__/CenterPanel.test.tsx

## QA Results

### QA Validation Summary
**Status:** PASS ✅  
**Validation Date:** 2025-09-14  
**QA Agent:** Quinn (Test Architect)  
**Validation Method:** Comprehensive live browser testing with Playwright + code inspection

### Implementation Verification Results

#### ✅ **PASS** - All Acceptance Criteria Met
1. **AC1: Entity Dropdown Filtering** - VERIFIED ✅
   - Dropdown correctly filters by selected incident (shows "4 entities available" for Armed Conflict incident)
   - "All Affected Entities" option properly included and auto-selected
   - Incident changes correctly reset entity selection

2. **AC2: Assessment Area Breakdown** - VERIFIED ✅
   - All 5 assessment areas displayed: Health, WASH, Food, Shelter, Security
   - Dual-column layout implemented with clear visual distinction
   - Left column: Latest assessment data with timestamps and severity badges
   - Right column: Gap analysis with color-coded indicators and explanations
   - API integration working: `/api/v1/monitoring/analytics/assessments/breakdown`

3. **AC3: Space Management** - VERIFIED ✅
   - Responsive space calculation functional (viewport resize from 1920x1080 to 1200x800)
   - Assessment areas reduced from 5 to 2 when space constrained
   - Selection control appeared: "Assessment Area Selection 2/2 selected"
   - Clear messaging: "Limited space allows displaying 2 of 5 assessment areas"

4. **AC4: Loading States** - VERIFIED ✅
   - Loading skeleton animations present during data fetching
   - Loading states displayed during cross-panel communication
   - Proper loading indicators for entity selection changes

5. **AC5: Visual Distinction** - VERIFIED ✅
   - Clear border separation between assessment data and gap analysis columns
   - Color-coded gap analysis: Green indicators for "No significant gaps identified"
   - Distinct typography and spacing for different data sections

#### ✅ **PASS** - Backend Connectivity & Data Quality
- **Real Database Integration**: APIs return authentic incident data ("Armed Conflict in Maiduguri", "Flooding in Lagos Island", "Drought in Kano Municipal")
- **Proper Authentication**: All API calls use NextAuth.js session validation
- **No Mock Data**: Gap analysis shows appropriate fallback behavior, not random values
- **Realistic Metrics**: Population impact shows meaningful data (39 injured, 1,170 displaced, 598 houses affected)

#### ✅ **PASS** - Component Architecture Quality
- **All Components Exist**: EntitySelector, AssessmentAreaBreakdown, GapAnalysisView, AreaSelectionManager, enhanced CenterPanel
- **Cross-Panel Communication**: Analytics store properly manages incident selection → entity filtering → assessment data flow
- **Error Handling**: Graceful degradation when no assessment data available
- **Code Quality**: Clean component structure, proper TypeScript interfaces, good separation of concerns

#### ✅ **PASS** - API Implementation Quality
- **Endpoint 1** (`/entities/by-incident/[id]`): Uses DatabaseService.getAffectedEntitiesByIncident() with proper error handling
- **Endpoint 2** (`/assessments/breakdown`): Real gap analysis calculations based on timestamps and severity data
- **No Hardcoded Values**: All data derived from database queries and calculations
- **Proper Response Structure**: Matches documented API specifications exactly

### Performance Validation
- **Initial Load**: ~6.7s for dev server startup (within acceptable range per CLAUDE.md)
- **Cross-Panel Updates**: Immediate response to incident selection changes
- **API Response Times**: All API calls respond within acceptable limits
- **Space Recalculation**: Instantaneous responsive behavior on viewport changes

### Integration Verification
- **IV1 PASS**: Assessment area data structures compatible with existing workflows
- **IV2 PASS**: Gap analysis calculations align with established response-to-assessment logic
- **IV3 PASS**: Assessment filtering maintains existing data validation patterns

### Test Coverage Assessment
All major user workflows tested:
- ✅ Incident selection triggers entity dropdown population
- ✅ Entity selection triggers assessment breakdown API calls
- ✅ Assessment areas display with proper formatting and gap analysis
- ✅ Space management adapts to viewport constraints
- ✅ Cross-panel state synchronization maintains consistency

### Quality Gate Decision
**PASS** - Story 1.3 implementation is COMPLETE and WORKING CORRECTLY

**Rationale:** All acceptance criteria met, backend properly connected with real data, cross-panel communication functional, space management responsive, and code quality excellent. No mock data or random values detected. Implementation ready for production deployment.

**Validation Evidence:**
- Live browser testing with Playwright confirmed all functionality
- API endpoints verified to use real DatabaseService methods
- Gap analysis shows logical fallback behavior appropriate for no-data scenarios
- Responsive design adapts correctly to different viewport sizes