# <!-- Powered by BMAD™ Core -->

# Story 1.6: Real-time Data Synchronization

## Status
Approved

## Story

**As a** Coordinator,  
**I want** dashboard data to automatically refresh when new assessments, responses, or incidents are recorded,  
**so that** I maintain current situational awareness without manual refresh actions.

## Acceptance Criteria

1. Dashboard subscribes to real-time data updates using existing patterns
2. Charts, maps, and summary components update automatically with new data
3. Update indicators show when fresh data is loaded
4. Graceful handling of temporary connectivity loss with retry logic
5. Update frequency balances real-time needs with performance considerations

### Integration Verification
- **IV1**: Real-time updates don't interfere with existing notification and sync systems
- **IV2**: Data update patterns maintain consistency with existing PWA offline strategies
- **IV3**: Update frequency and resource usage remain within acceptable system limits

## Tasks / Subtasks

- [ ] Implement real-time subscription mechanism (AC: 1, 2)
  - [ ] Create WebSocket or Server-Sent Events connection management in analytics store
  - [ ] Integrate with existing 25-second refresh pattern from monitoring.store.ts
  - [ ] Implement data change notification subscription for incidents, assessments, responses
  - [ ] Add connection status monitoring and automatic reconnection logic

- [ ] Add automatic component data refresh (AC: 2, 3)
  - [ ] Update LeftPanel to refresh incident summaries when new data arrives
  - [ ] Update CenterPanel to refresh assessment breakdowns and entity data automatically
  - [ ] Update RightPanel to refresh entity gaps and statistics in real-time
  - [ ] Update InteractiveMap to refresh entity markers and overlays dynamically
  - [ ] Implement loading indicators during data refresh operations

- [ ] Implement update indicators and user feedback (AC: 3)
  - [ ] Create UpdateIndicator component to show data freshness status
  - [ ] Add timestamp displays for "last updated" information across panels
  - [ ] Implement toast notifications for successful data refreshes
  - [ ] Add visual indicators for stale data during connectivity issues

- [ ] Handle connectivity issues and offline scenarios (AC: 4, IV2)
  - [ ] Implement retry logic for failed real-time connections
  - [ ] Add graceful degradation to polling when real-time connections fail
  - [ ] Integrate with existing PWA offline strategies and service worker patterns
  - [ ] Maintain data consistency during offline-to-online transitions

- [ ] Optimize update frequency and performance (AC: 5, IV3)
  - [ ] Implement intelligent update frequency based on data change patterns
  - [ ] Add debouncing for rapid successive updates to prevent UI thrashing
  - [ ] Optimize API calls to only fetch changed data, not full datasets
  - [ ] Monitor and limit resource usage within system performance budgets

- [ ] Unit and integration testing (Testing Standards)
  - [ ] Create real-time synchronization test suite with mock WebSocket connections
  - [ ] Test update indicators and user feedback components
  - [ ] Test connectivity failure scenarios and retry mechanisms
  - [ ] Test performance under high-frequency update scenarios
  - [ ] Integration tests with existing monitoring and sync systems

## Dev Notes

### Previous Story Insights
Previous Story 1.5 successfully implemented Interactive Map Integration with React-Map-GL migration from React-Leaflet due to Next.js 14 compatibility issues. The analytics store integration and cross-panel communication patterns are established and working well. Real-time synchronization will build upon this solid foundation of state management and component communication.

### Data Models

**Real-time Update Data Structure** [Source: architecture/analytics-dashboard-enhancement-architecture.md#api-design]:
- Real-time updates integrate with existing 25-second refresh intervals from monitoring.store.ts
- Update notifications include data type, affected entities, and change timestamps
- Connection status managed through analytics.store.ts with automatic reconnection

**Update Notification Response** [Source: architecture/analytics-dashboard-enhancement-architecture.md#api-endpoints]:
```json
{
  "type": "data_update",
  "timestamp": "2025-09-16T12:00:00Z",
  "changes": {
    "incidents": ["incident-1"],
    "assessments": ["assessment-1", "assessment-2"],
    "responses": ["response-1"]
  },
  "affectedEntities": ["entity-1", "entity-2"]
}
```

### API Specifications

**Real-time Connection Management** [Source: architecture/analytics-dashboard-enhancement-architecture.md#api-integration]:
- **Connection Type**: Server-Sent Events (SSE) or WebSocket connection to `/api/v1/monitoring/analytics/realtime`
- **Fallback Strategy**: Polling every 25 seconds when real-time connection unavailable
- **Integration**: Extends existing monitoring API patterns without modifications

**Update Endpoints** [Source: architecture/analytics-dashboard-enhancement-architecture.md#api-endpoints]:
- **GET /api/v1/monitoring/analytics/updates/since/{timestamp}**: Fetch updates since last sync
- **POST /api/v1/monitoring/analytics/subscribe**: Subscribe to real-time updates for specific data types
- **Authentication**: Inherits existing NextAuth.js session validation automatically

### Component Specifications

**Real-time Update Integration** [Source: architecture/analytics-dashboard-enhancement-architecture.md#component-architecture]:
- **UpdateIndicator Component**: Shows connection status and last update time across all panels
- **Analytics Store Enhancement**: Add real-time subscription management to existing analytics.store.ts
- **Cross-Panel Coordination**: Real-time updates trigger coordinated refresh across LeftPanel, CenterPanel, RightPanel, and InteractiveMap

**Performance Optimization** [Source: architecture/analytics-dashboard-enhancement-architecture.md#performance-optimization]:
- Debounced updates prevent UI thrashing during rapid data changes
- Selective component re-rendering using React.memo and useCallback patterns
- Intelligent caching to minimize redundant API calls

### File Locations

**Component Files** [Source: architecture/source-tree.md, analytics-dashboard-enhancement-architecture.md#source-tree-integration]:
```
packages/frontend/src/components/features/analytics/
├── UpdateIndicator.tsx         # Real-time update status indicator
├── realtime/
│   ├── RealtimeConnection.tsx  # WebSocket/SSE connection management
│   ├── UpdateManager.tsx       # Coordinates updates across components
│   └── ConnectivityHandler.tsx # Handles offline/online transitions
```

**Store Enhancement** [Source: architecture/analytics-dashboard-enhancement-architecture.md#component-architecture]:
```
packages/frontend/src/stores/
└── analytics.store.ts          # Enhanced with real-time subscription management
```

**API Routes** [Source: architecture/analytics-dashboard-enhancement-architecture.md#api-endpoints]:
```
packages/frontend/src/app/api/v1/monitoring/analytics/
├── realtime/
│   └── route.ts               # Real-time connection endpoint
└── updates/
    └── since/
        └── [timestamp]/
            └── route.ts       # Incremental updates endpoint
```

### Testing Requirements

**Test Framework** [Source: architecture/qa/test-strategy.md#testing-tools]:
- Jest for unit tests with React Testing Library
- Mock WebSocket/SSE connections for real-time testing
- Integration tests for cross-panel update coordination
- Test location: `packages/frontend/tests/components/features/analytics/realtime/`

**Key Test Areas** [Source: architecture/qa/test-strategy.md#test-categories]:
- Real-time connection establishment and management
- Update indicator accuracy and user feedback
- Connectivity failure handling and recovery
- Performance under high-frequency update scenarios
- Integration with existing PWA offline capabilities

### Technical Constraints

**Technology Stack** [Source: architecture/2-tech-stack.md, analytics-dashboard-enhancement-architecture.md#tech-stack]:
- Next.js 14.2.x Client Component with 'use client' directive for real-time features
- React 18.3.x functional components with useEffect for subscription management
- Zustand 4.5.x for analytics.store.ts real-time state management
- Native WebSocket or Server-Sent Events for real-time connections (no additional libraries)
- Integration with existing next-pwa 5.6.x service worker patterns

**Performance Requirements** [Source: architecture/analytics-dashboard-enhancement-architecture.md#compatibility-requirements]:
- Maintain existing 25-second refresh pattern as fallback
- Real-time updates should not exceed 150KB additional bundle size
- Connection management optimized for intermittent connectivity scenarios
- Memory usage increase capped at <5% for real-time subscription features

**Real-time Integration Requirements** [Source: architecture/analytics-dashboard-enhancement-architecture.md#compatibility-requirements]:
- No modifications to existing monitoring or notification systems
- Compatible with existing PWA offline-first architecture
- Graceful degradation when real-time connections unavailable
- Maintain existing authentication and session management patterns

## Testing

### Testing Standards [Source: docs/qa/test-strategy.md]

**Test File Location**: `packages/frontend/tests/components/features/analytics/realtime/`
- RealtimeConnection.test.tsx
- UpdateManager.test.tsx  
- UpdateIndicator.test.tsx
- ConnectivityHandler.test.tsx

**Test Frameworks and Patterns**:
- Jest with React Testing Library for component testing
- Mock WebSocket/SSE connections for real-time functionality testing
- Integration tests for cross-panel update coordination
- Performance testing for high-frequency update scenarios

**Specific Testing Requirements**:
- Real-time connection establishment and automatic reconnection
- Update indicator accuracy and visual feedback
- Cross-panel data refresh coordination
- Connectivity failure handling and graceful degradation
- Integration with existing PWA offline capabilities

**Performance Testing**:
- Memory usage monitoring during extended real-time sessions
- Update frequency optimization validation
- Resource usage compliance with system performance budgets
- Stress testing with rapid successive updates

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-16 | 1.0 | Initial story creation with comprehensive technical context | Bob (SM) |