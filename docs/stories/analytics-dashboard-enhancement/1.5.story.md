# <!-- Powered by BMAD™ Core -->

# Story 1.5: Interactive Map Integration

## Status
Draft

## Story

**As a** Coordinator,  
**I want** an interactive map at the bottom of the center panel showing all affected entities with highlighting for selected entities,  
**so that** I can visualize geographic context of assessments, responses, and coverage gaps.

## Acceptance Criteria

1. Map displays at bottom of center panel without requiring panel scrolling
2. All affected entities shown as map markers/layers regardless of selection
3. Selected entity (or all entities) highlighted with distinct visual treatment
4. Map updates highlighting based on center panel entity selection
5. Map shows assessment locations, response coverage, and gap analysis overlays
6. Map integration maintains existing geographic data patterns

### Integration Verification
- **IV1**: Map functionality doesn't interfere with existing geographic features in DMS
- **IV2**: Geographic data APIs continue serving existing mapping needs uninterrupted
- **IV3**: Map rendering performance doesn't impact overall dashboard responsiveness

## Tasks / Subtasks

- [ ] Create InteractiveMap component structure (AC: 1, 2)
  - [ ] Set up InteractiveMap.tsx component in `/components/features/analytics/`
  - [ ] Integrate Leaflet with existing offline mapping patterns 
  - [ ] Implement responsive layout for center panel bottom positioning
  - [ ] Add proper TypeScript interfaces for map component props

- [ ] Implement entity markers and highlighting system (AC: 2, 3, 4)
  - [ ] Create EntityMarker.tsx component for individual entity display
  - [ ] Integrate with analytics store for entity selection state
  - [ ] Implement highlighting logic for selected vs. unselected entities
  - [ ] Add support for "All Entities" selection mode with group highlighting

- [ ] Add assessment and response coverage overlays (AC: 5, 6)
  - [ ] Create AssessmentOverlay.tsx component for assessment location display
  - [ ] Create ResponseOverlay.tsx component for response coverage visualization
  - [ ] Create GapAnalysisOverlay.tsx component for gap visualization
  - [ ] Integrate with existing geographic data APIs for coordinate information

- [ ] Implement dynamic map updates (AC: 4, IV1, IV2)
  - [ ] Connect to analytics.store.ts for cross-panel entity selection
  - [ ] Subscribe to entity selection changes from center panel dropdown
  - [ ] Implement real-time highlighting updates without full map re-render
  - [ ] Maintain existing geographic data patterns and API compatibility

- [ ] Optimize map performance and integration (AC: 1, IV3)
  - [ ] Implement efficient map rendering within center panel constraints
  - [ ] Add proper loading states during map initialization
  - [ ] Optimize marker clustering for large entity datasets
  - [ ] Test map responsiveness under different screen sizes and data loads

- [ ] Unit testing (Testing Standards)
  - [ ] Create InteractiveMap.test.tsx with React Testing Library
  - [ ] Test EntityMarker component rendering and highlighting
  - [ ] Test map overlay components display and data integration
  - [ ] Test entity selection highlighting and map updates
  - [ ] Test performance and responsiveness under various data loads

## Dev Notes

### Previous Story Insights
Previous Story 1.4 successfully implemented Entity Gaps Summary and Quick Statistics with color-coded severity indicators. The analytics store integration and cross-panel communication patterns are established and working well. The right panel components demonstrate effective use of dynamic updates based on incident selection from the left panel.

### Data Models

**Geographic Entity Data Structure** [Source: architecture/analytics-dashboard-enhancement-architecture.md#api-design]:
- Entity coordinates from existing geographic data APIs
- Entity selection state managed through analytics.store.ts 
- Map highlighting coordinated with center panel dropdown selection

**Map Marker Data Response** [Source: architecture/analytics-dashboard-enhancement-architecture.md#api-endpoints]:
```json
{
  "entities": [
    {
      "id": "entity-1",
      "name": "Maiduguri Metropolitan",
      "type": "LGA",
      "coordinates": [11.8311, 13.1511]
    }
  ]
}
```

### API Specifications

**Primary Endpoint** [Source: architecture/analytics-dashboard-enhancement-architecture.md#api-endpoints]:
- **GET /api/v1/monitoring/analytics/entities/by-incident/{id}**
- Purpose: Filtered list of entities affected by specific incident with coordinates for map display
- Request: `{ "incidentId": "string", "includeAll": true }`
- Integration: Provides geographic coordinates for existing entities without schema modifications

**Geographic Data Integration** [Source: architecture/analytics-dashboard-enhancement-architecture.md#compatibility-requirements]:
- Uses existing geographic data APIs without modification
- Maintains compatibility with current entity coordinate systems
- Leverages established Leaflet integration patterns from existing DMS mapping

### Component Specifications

**InteractiveMap Component Architecture** [Source: architecture/analytics-dashboard-enhancement-architecture.md#component-architecture]:
- Responsibility: Interactive map display with entity highlighting and assessment/response overlays
- Integration Points: Center panel bottom positioning, analytics store for entity selection state
- Dependencies: Leaflet 1.9.x for mapping, existing offline mapping capabilities
- Sub-components: EntityMarker, AssessmentOverlay, ResponseOverlay, GapAnalysisOverlay

**Cross-Panel Communication** [Source: architecture/analytics-dashboard-enhancement-architecture.md#cross-panel-communication]:
- Entity selection in CenterPanel triggers map highlighting to show selected entity or all entities
- All state changes flow through analytics.store.ts for predictable state management
- Map updates based on center panel dropdown selection without affecting other panels

### File Locations

**Component Files** [Source: architecture/source-tree.md, analytics-dashboard-enhancement-architecture.md#source-tree-integration]:
```
packages/frontend/src/components/features/analytics/
├── InteractiveMap.tsx          # Main interactive map component
├── EntityMarker.tsx            # Individual entity marker component
├── AssessmentOverlay.tsx       # Assessment location overlay
├── ResponseOverlay.tsx         # Response coverage overlay
└── GapAnalysisOverlay.tsx      # Gap analysis visualization overlay
```

**Integration Point** [Source: architecture/analytics-dashboard-enhancement-architecture.md#component-architecture]:
```
packages/frontend/src/components/features/analytics/
└── CenterPanel.tsx             # Updated to include InteractiveMap at bottom
```

### Testing Requirements

**Test Framework** [Source: architecture/qa/test-strategy.md#testing-tools]:
- Jest for unit tests with React Testing Library
- Focus on map component rendering, entity highlighting, and dynamic updates
- Test location: `packages/frontend/tests/components/features/analytics/`

**Key Test Areas** [Source: architecture/qa/test-strategy.md#test-categories]:
- Map initialization and entity marker display
- Entity highlighting based on selection state changes
- Map overlay rendering for assessments and responses
- Performance testing for large entity datasets
- Integration with analytics store state management

### Technical Constraints

**Technology Stack** [Source: architecture/2-tech-stack.md, analytics-dashboard-enhancement-architecture.md#tech-stack]:
- Next.js 14.2.x Client Component with 'use client' directive
- React 18.3.x functional component with hooks
- Leaflet 1.9.x for interactive mapping with existing offline capabilities
- Zustand 4.5.x for analytics.store.ts state management
- Tailwind CSS 3.4.x for styling and responsive design

**Map Integration Requirements** [Source: architecture/analytics-dashboard-enhancement-architecture.md#compatibility-requirements]:
- Use existing Leaflet 1.9.x integration patterns from current DMS mapping
- Maintain offline tile support and caching strategies
- Component bundle size contribution within portion of 150KB gzipped total
- Responsive design optimized for 1920x1080+ monitoring room displays

**Geographic Data Compatibility** [Source: architecture/analytics-dashboard-enhancement-architecture.md#compatibility-requirements]:
- No modifications to existing geographic data APIs
- Use current entity coordinate systems and data structures
- Maintain existing error boundary patterns and logging
- Follow established offline mapping patterns for PWA compliance

## Testing

### Testing Standards [Source: docs/qa/test-strategy.md]

**Test File Location**: `packages/frontend/tests/components/features/analytics/`
- InteractiveMap.test.tsx
- EntityMarker.test.tsx  
- AssessmentOverlay.test.tsx
- ResponseOverlay.test.tsx
- GapAnalysisOverlay.test.tsx

**Test Frameworks and Patterns**:
- Jest with React Testing Library for component testing
- Unit tests for map component functionality
- Integration tests for cross-panel state management
- Test coverage >80% for map logic and entity highlighting

**Specific Testing Requirements**:
- Map initialization and marker rendering validation
- Entity highlighting behavior when selection changes
- Map overlay display for assessments and response coverage
- Performance testing with large entity datasets
- Cross-panel communication through analytics store

**Performance Testing**:
- Map rendering performance under large data sets
- Entity highlighting update efficiency 
- Memory usage monitoring for map tile caching
- Responsive behavior across different screen sizes

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-16 | 1.0 | Initial story creation with comprehensive technical context | Bob (SM) |

## Dev Agent Record

### Agent Model Used


### Debug Log References  


### Completion Notes List


### File List


## QA Results