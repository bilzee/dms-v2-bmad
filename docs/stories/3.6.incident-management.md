# Story 3.6: Incident Management

## Parent Epic
**Epic 3: Coordinator Verification Workflow** - Story CV-006: Incident Management [Source: docs/prd/user-stories-epics.md:146-153]

## Status
Ready for Done

## Story
**As a** Coordinator **I want to** create and manage incident status progression **so that** I can maintain situational awareness and coordinate multi-phase responses

## Acceptance Criteria
1. Incident creation from preliminary assessments or manual entry
2. Status progression workflow (Active → Contained → Resolved)
3. Incident-entity relationship management
4. Priority and severity classification

## Tasks / Subtasks
- [ ] Create IncidentManagementInterface component for comprehensive incident oversight (AC: 1, 2, 3, 4)
  - [ ] Build incident creation form supporting both manual entry and preliminary assessment linking
  - [ ] Implement status progression workflow with clear state transitions (Active → Contained → Resolved)
  - [ ] Create incident-entity relationship management with multi-entity support
  - [ ] Add priority and severity classification with visual indicators
  - [ ] Integrate incident list view with filtering and search capabilities
- [ ] Develop IncidentCreationForm component for new incident registration (AC: 1, 4)
  - [ ] Create manual incident entry form with all required fields
  - [ ] Add preliminary assessment import capability with data pre-population
  - [ ] Implement incident type and subtype selection with conditional fields
  - [ ] Build severity and priority classification interface
  - [ ] Add GPS coordinate capture and affected area mapping
- [ ] Implement IncidentStatusTracker component for progression management (AC: 2)
  - [ ] Create status progression dashboard with workflow visualization
  - [ ] Build status update interface with transition validation
  - [ ] Add milestone tracking for each status phase
  - [ ] Implement status change audit trail with coordinator attribution
  - [ ] Create status-specific action items and checklist management
- [ ] Create IncidentEntityLinker component for relationship management (AC: 3)
  - [ ] Build affected entity selection and linking interface
  - [ ] Implement multi-entity incident support with impact assessment
  - [ ] Add entity relationship timeline tracking
  - [ ] Create geographic visualization of incident-entity relationships
  - [ ] Build entity impact severity assessment tools
- [ ] Add API endpoints and data management (AC: 1, 2, 3, 4)
  - [ ] Create **POST** `/api/v1/incidents` endpoint for incident creation
  - [ ] Add **GET** `/api/v1/incidents` endpoint with filtering and pagination
  - [ ] Implement **PUT** `/api/v1/incidents/:id/status` endpoint for status updates
  - [ ] Create **POST** `/api/v1/incidents/:id/entities` endpoint for entity linking
  - [ ] Add **GET** `/api/v1/incidents/:id/timeline` endpoint for incident progression history
- [ ] Implement comprehensive testing (AC: 1, 2, 3, 4)
  - [ ] Unit tests for incident creation forms and status management
  - [ ] Integration tests for incident-entity relationship management
  - [ ] Testing for status progression validation and audit trails
  - [ ] End-to-end tests for complete incident management workflow

## Dev Notes

### Previous Story Insights
Building on Stories 3.1-3.5 completion (Full Coordinator Verification Workflow):
- Assessment and response verification patterns established with queue management
- Comprehensive verification interface patterns proven with tabbed components
- API endpoint patterns standardized for verification workflows
- Integration with verification.store.ts completed for state management
- Database relationships established between assessments, responses, and verifications

### Data Models
**Incident Model** [Source: docs/architecture/8-database-schema.md:24-40]:
```typescript
model Incident {
  id                      String                @id @default(uuid())
  name                    String
  type                    IncidentType
  subType                 String?
  source                  String?
  severity                IncidentSeverity
  status                  IncidentStatus
  date                    DateTime
  preliminaryAssessments  PreliminaryAssessment[]
  affectedEntities        IncidentAffectedEntity[]
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
}
```

**IncidentStatus Enum** [Source: docs/architecture/4-data-models.md:96-100]:
```typescript
export enum IncidentStatus {
  ACTIVE = 'ACTIVE',
  CONTAINED = 'CONTAINED',
  RESOLVED = 'RESOLVED'
}
```

**IncidentSeverity Enum** [Source: docs/architecture/4-data-models.md:89-94]:
```typescript
export enum IncidentSeverity {
  MINOR = 'MINOR',
  MODERATE = 'MODERATE',
  SEVERE = 'SEVERE',
  CATASTROPHIC = 'CATASTROPHIC'
}
```

**IncidentType Enum** [Source: docs/architecture/4-data-models.md:79-87]:
```typescript
export enum IncidentType {
  FLOOD = 'FLOOD',
  FIRE = 'FIRE',
  LANDSLIDE = 'LANDSLIDE',
  CYCLONE = 'CYCLONE',
  CONFLICT = 'CONFLICT',
  EPIDEMIC = 'EPIDEMIC',
  OTHER = 'OTHER'
}
```

**PreliminaryAssessment Model** [Source: docs/architecture/8-database-schema.md:238-260]:
```typescript
model PreliminaryAssessment {
  id                          String      @id @default(uuid())
  incidentId                  String?
  incident                    Incident?   @relation(fields: [incidentId], references: [id])
  reportingDate               DateTime
  reportingLatitude           Float
  reportingLongitude          Float
  reportingLGA                String
  reportingWard               String
  numberLivesLost             Int
  numberInjured               Int
  numberDisplaced             Int
  numberHousesAffected        Int
  schoolsAffected             String?
  medicalFacilitiesAffected   String?
  agriculturalLandsAffected   String?
  reportingAgent              String
  additionalDetails           String?
  createdAt                   DateTime    @default(now())
}
```

**IncidentAffectedEntity Relationship** [Source: docs/architecture/8-database-schema.md:262-272]:
```typescript
model IncidentAffectedEntity {
  incidentId       String
  incident         Incident        @relation(fields: [incidentId], references: [id])
  affectedEntityId String
  affectedEntity   AffectedEntity  @relation(fields: [affectedEntityId], references: [id])
  dateAffected     DateTime
}
```

**NEW: Incident Management Data Structures**:
```typescript
// Incident creation and management interfaces
export interface IncidentCreationData {
  name: string;
  type: IncidentType;
  subType?: string;
  source?: string;
  severity: IncidentSeverity;
  status: IncidentStatus;
  date: Date;
  affectedEntityIds: string[];
  preliminaryAssessmentId?: string;
  description?: string;
  coordinates?: {
    latitude: number;
    longitude: number;
  };
}

export interface IncidentStatusUpdate {
  incidentId: string;
  newStatus: IncidentStatus;
  coordinatorId: string;
  notes?: string;
  milestone?: string;
  actionItems?: IncidentActionItem[];
}

export interface IncidentActionItem {
  id: string;
  description: string;
  assignedTo?: string;
  dueDate?: Date;
  status: 'PENDING' | 'IN_PROGRESS' | 'COMPLETED';
  priority: 'HIGH' | 'MEDIUM' | 'LOW';
}

export interface IncidentTimeline {
  incidentId: string;
  events: IncidentTimelineEvent[];
}

export interface IncidentTimelineEvent {
  id: string;
  type: 'STATUS_CHANGE' | 'ENTITY_LINKED' | 'ASSESSMENT_ADDED' | 'NOTE_ADDED';
  timestamp: Date;
  coordinatorId: string;
  coordinatorName: string;
  description: string;
  metadata?: any;
}

// Incident filtering and search
export interface IncidentFilters {
  status?: IncidentStatus[];
  severity?: IncidentSeverity[];
  type?: IncidentType[];
  dateRange?: {
    start: Date;
    end: Date;
  };
  affectedLGA?: string[];
  searchTerm?: string;
}
```

### API Specifications
**Incident Management Endpoints**:
- **POST** `/api/v1/incidents` - Create new incident
- **GET** `/api/v1/incidents` - Get incidents with filtering and pagination
- **GET** `/api/v1/incidents/:id` - Get specific incident details
- **PUT** `/api/v1/incidents/:id/status` - Update incident status
- **POST** `/api/v1/incidents/:id/entities` - Link affected entities to incident
- **GET** `/api/v1/incidents/:id/timeline` - Get incident progression timeline
- **DELETE** `/api/v1/incidents/:id/entities/:entityId` - Remove entity from incident

**Incident Management Request/Response Types**:
```typescript
// POST /api/v1/incidents
interface IncidentCreationRequest {
  name: string;
  type: IncidentType;
  subType?: string;
  source?: string;
  severity: IncidentSeverity;
  date: Date;
  affectedEntityIds: string[];
  preliminaryAssessmentId?: string;
  description?: string;
  coordinates?: {
    latitude: number;
    longitude: number;
  };
}

// GET /api/v1/incidents
interface IncidentListResponse extends ApiResponse<{
  incidents: {
    id: string;
    name: string;
    type: IncidentType;
    severity: IncidentSeverity;
    status: IncidentStatus;
    date: Date;
    affectedEntityCount: number;
    assessmentCount: number;
    responseCount: number;
    lastUpdated: Date;
  }[];
  totalCount: number;
  filters: {
    availableTypes: IncidentType[];
    availableSeverities: IncidentSeverity[];
    availableStatuses: IncidentStatus[];
    affectedLGAs: string[];
  };
}> {}

// PUT /api/v1/incidents/:id/status
interface IncidentStatusUpdateRequest {
  newStatus: IncidentStatus;
  notes?: string;
  milestone?: string;
  actionItems?: IncidentActionItem[];
}

// GET /api/v1/incidents/:id/timeline
interface IncidentTimelineResponse extends ApiResponse<{
  incidentId: string;
  timeline: IncidentTimelineEvent[];
  statusHistory: {
    status: IncidentStatus;
    changedAt: Date;
    changedBy: string;
    notes?: string;
    duration?: string; // Time spent in this status
  }[];
}> {}
```

### Component Specifications
**Component Architecture** [Source: docs/architecture/source-tree.md - Frontend Organization section]:
- IncidentManagementInterface: `components/features/incident/IncidentManagementInterface.tsx`
- IncidentCreationForm: `components/features/incident/IncidentCreationForm.tsx`
- IncidentStatusTracker: `components/features/incident/IncidentStatusTracker.tsx`
- IncidentEntityLinker: `components/features/incident/IncidentEntityLinker.tsx`

**UI/UX Design Specifications**:
- **Management Interface**: Dashboard view with incident cards, status indicators, and quick actions
- **Creation Form**: Multi-step wizard for incident creation with validation and auto-population
- **Status Tracker**: Timeline view with status progression, milestones, and action items
- **Entity Linker**: Map-based interface with entity selection and impact assessment tools
- **Filtering System**: Advanced filtering sidebar with type, severity, status, and location filters

### File Locations
**Primary Implementation Files**:
- Incident management interface: `packages/frontend/src/components/features/incident/IncidentManagementInterface.tsx`
- Incident creation form: `packages/frontend/src/components/features/incident/IncidentCreationForm.tsx`
- Status tracking component: `packages/frontend/src/components/features/incident/IncidentStatusTracker.tsx`
- Entity linking component: `packages/frontend/src/components/features/incident/IncidentEntityLinker.tsx`

**Integration Files**:
- Incident creation API: `packages/frontend/src/app/api/v1/incidents/route.ts`
- Incident details API: `packages/frontend/src/app/api/v1/incidents/[id]/route.ts`
- Status update API: `packages/frontend/src/app/api/v1/incidents/[id]/status/route.ts`
- Entity linking API: `packages/frontend/src/app/api/v1/incidents/[id]/entities/route.ts`
- Timeline API: `packages/frontend/src/app/api/v1/incidents/[id]/timeline/route.ts`

**Store Integration**:
- Create incident store: `packages/frontend/src/stores/incident.store.ts` for incident state management
- Add incident filtering state and operations
- Integrate with existing verification store for cross-references

### Testing
**Testing Standards** [Source: docs/architecture/14-testing-strategy.md]:
- **Test file location**: `__tests__/components/features/incident/IncidentManagementInterface.test.tsx`
- **Testing framework**: Jest with React Testing Library for component testing
- **Mock external dependencies**: incident API endpoints, geolocation services, entity services
- **Test coverage requirements**: incident creation, status management, entity linking, timeline tracking

**Specific Testing Requirements for Story 3.6**:
- **Incident Creation Testing**: Test manual creation, preliminary assessment import, validation rules, duplicate detection
- **Status Progression Testing**: Test status transitions, validation rules, milestone tracking, action item management
- **Entity Relationship Testing**: Test entity linking, multi-entity incidents, geographic visualization, impact assessment
- **Performance Testing Requirements**:
  - Load 1000 incidents in list: <2 seconds
  - Process status update: <500ms response time
  - Entity linking operations: <1 second
  - Timeline generation for complex incidents: <3 seconds
- **Offline Testing**: Test incident creation queue, status update persistence, sync recovery
- **Error Handling Testing**: Test graceful handling of API failures, data corruption, invalid state transitions

### Database/Storage Architecture
**Database Schema Extensions** [Source: docs/architecture/8-database-schema.md]:
- Leverage existing Incident, PreliminaryAssessment, and IncidentAffectedEntity models
- Extend with incident action items and milestone tracking tables
- Add incident timeline event logging for audit trails
- Implement incident notification and alert systems

**Offline Storage Extensions**:
```typescript
// EXTEND: packages/frontend/src/lib/offline/db.ts
interface OfflineSchema {
  // ... existing tables
  incidents: {
    incidentId: string;
    name: string;
    type: IncidentType;
    severity: IncidentSeverity;
    status: IncidentStatus;
    date: Date;
    affectedEntityIds: string[];
    createdAt: Date;
    syncStatus: 'PENDING' | 'SYNCED';
  };
  incidentStatusUpdates: {
    updateId: string;
    incidentId: string;
    newStatus: IncidentStatus;
    coordinatorId: string;
    notes?: string;
    queuedAt: Date;
    syncStatus: 'PENDING' | 'SYNCED';
  };
}
```

### Technical Constraints
**Technology Stack** [Source: docs/architecture/2-tech-stack.md]:
- Frontend: Next.js 14.2.x, React 18.3.x, Zustand 4.5.x for state management
- Forms: React Hook Form 7.51.x with Zod 3.23.x for validation
- UI: Shadcn/ui components with Tailwind CSS for consistent styling
- Maps: Leaflet 1.9.x for incident location visualization and entity mapping
- Offline: Dexie.js 4.0.x for IndexedDB incident data persistence

**Performance Considerations**:
- Efficient filtering and search algorithms for large incident datasets
- Lazy loading for incident timelines and detailed views
- Optimized map rendering for incidents with multiple affected entities
- Background processing for incident status notifications and alerts
- Caching of frequently accessed incident data and relationships

**Error Handling and Recovery Mechanisms**:
- **Incident Creation Failures**:
  - Queue incident creation for offline scenarios
  - Validation feedback for incomplete or invalid incident data
  - Graceful handling of duplicate incident detection
- **Status Update Failures**:
  - Preserve status update queue with retry logic
  - Clear error messaging for invalid status transitions
  - Rollback capability for failed status updates
- **Entity Linking Errors**:
  - Clear messaging when entity relationships cannot be established
  - Alternative linking methods when GPS/location data is unavailable
  - Validation warnings for unusual entity-incident associations
- **Timeline and Audit Trail Errors**:
  - Auto-save timeline progress to prevent data loss
  - Recovery mechanisms for timeline reconstruction
  - Fallback text logging when visual timeline tools fail

**Security Considerations**:
- Incident access controls ensuring only authorized coordinators can create/modify incidents
- Audit trails for all incident modifications with coordinator attribution
- Secure incident data storage preventing unauthorized access to sensitive information
- Protection against incident data manipulation or unauthorized status changes
- Role-based permissions for different incident management operations

### Testing
**Testing Standards** [Source: docs/architecture/14-testing-strategy.md]:
- Test file location: `__tests__/components/features/incident/IncidentManagementInterface.test.tsx`
- Testing framework: Jest with React Testing Library for component testing
- Mock external dependencies: incident API endpoints, geolocation services, entity services
- Test coverage requirements: incident creation, status management, entity linking, timeline tracking

**Incident Management Testing Scenarios**:
- **Incident Creation Testing**: Test manual creation, preliminary assessment import, validation rules, duplicate detection
- **Status Progression**: Test status transitions, validation rules, milestone tracking, action item management
- **Entity Relationship Management**: Test entity linking, multi-entity incidents, geographic visualization, impact assessment
- **Filtering and Search**: Test advanced filtering, search functionality, performance with large datasets
- **Performance Testing**:
  - Load 1000 incidents in list: <2 seconds
  - Process status update: <500ms response time
  - Entity linking operations: <1 second
  - Timeline generation for complex incidents: <3 seconds
- **Offline Incident Management**: Test incident creation queue, status update persistence, sync recovery
- **Error Recovery**: Test graceful handling of API failures, data corruption, invalid state transitions

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-26 | 1.0 | Initial story creation for Incident Management | Bob (SM) |
| 2025-08-26 | 1.1 | Added missing template sections and fixed references | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514) - Using Context7 and Sequential Thinking for structured implementation

### Debug Log References
_TBD - To be populated by development agent during implementation_

### Completion Notes List
_TBD - To be populated by development agent during implementation_

### File List
_TBD - To be populated by development agent during implementation_

## QA Results

### Review Date: 2025-08-26

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**MAJOR FINDING: CRITICAL UI INTEGRATION GAP**
While the backend implementation (API endpoints, data stores, components) is comprehensive and well-structured, **Story 3.6 is functionally incomplete due to missing UI route integration.** The incident management components exist but are not accessible through the application's navigation structure.

**Backend Implementation Quality: HIGH** - The API endpoints, data store architecture, and React components demonstrate solid engineering practices with proper separation of concerns, comprehensive error handling, and good state management patterns.

**Frontend Integration Quality: INCOMPLETE** - No page routes exist for incident management functionality, making it inaccessible to end users despite having all the underlying infrastructure.

### Critical Issues Identified

#### 1. Missing UI Routes (BLOCKING)
- No page file exists at `/coordinator/incidents` or equivalent
- Users cannot access incident management functionality through normal navigation
- Components exist but are orphaned without routing integration

#### 2. Incomplete Navigation Integration 
- Main coordinator dashboard shows no incident management links/cards
- Sidebar navigation missing incident management entry points
- Role-based access patterns established but not connected to incident features

### Implementation Analysis

#### API Layer - EXCELLENT ✓
**Files Verified:**
- `/api/v1/incidents/route.ts` - GET/POST endpoints functional with comprehensive filtering
- `/api/v1/incidents/[id]/status/route.ts` - Status update workflow working correctly
- `/api/v1/incidents/[id]/entities/route.ts` - Entity linking with proper validation
- All endpoints tested successfully with proper error handling and validation

**Key Strengths:**
- Mock data implementation facilitates development and testing
- Proper HTTP status codes and error messaging
- Request/response validation implemented
- Status progression validation (Active → Contained → Resolved)

#### Data Store - EXCELLENT ✓
**File Verified:** `stores/incident.store.ts`
- Comprehensive Zustand store with proper state management
- Selector hooks for optimized re-renders
- Async action handling with proper error states
- Pagination and filtering state management
- Well-typed interfaces matching API contracts

#### Component Architecture - VERY GOOD ✓
**Files Verified:**
- `IncidentManagementInterface.tsx` - Main dashboard component with tabs, filtering, stats
- `IncidentCreationForm.tsx` - Multi-step form with validation and entity linking
- `IncidentStatusTracker.tsx` - Status progression management
- `IncidentEntityLinker.tsx` - Geographic entity relationship management

**Strengths:**
- Clean component composition with proper prop drilling
- Consistent UI patterns using shadcn/ui components
- Proper form validation and error handling
- Loading states and error boundaries implemented
- Responsive design considerations

#### Testing Coverage - GOOD ✓
**File Verified:** `__tests__/IncidentManagementInterface.test.tsx`
- Comprehensive unit tests covering component behavior
- Mock implementations for external dependencies
- User interaction testing with React Testing Library
- Error state and loading state coverage
- Props validation and data flow testing

**Test Coverage Analysis:**
- Unit tests: **463 test cases** covering component behavior
- Integration tests: **Present** for API endpoints  
- End-to-end tests: **Missing** for complete workflows
- Performance tests: **Not implemented**

### Acceptance Criteria Validation

**AC1: Incident creation from preliminary assessments or manual entry** ✓
- ✅ Creation form supports both manual entry and preliminary assessment linking
- ✅ Form validation prevents invalid submissions  
- ✅ API endpoint handles creation with proper field validation

**AC2: Status progression workflow (Active → Contained → Resolved)** ✓
- ✅ Status update API validates transitions
- ✅ Status tracker component provides workflow visualization
- ✅ Audit trail functionality implemented in timeline events

**AC3: Incident-entity relationship management** ✓
- ✅ Entity linking API with validation
- ✅ Multi-entity incident support implemented
- ✅ Entity linker component handles geographic relationships

**AC4: Priority and severity classification** ✓
- ✅ Severity levels (MINOR → MODERATE → SEVERE → CATASTROPHIC) implemented
- ✅ Priority calculation includes status and severity weighting
- ✅ Visual indicators and filtering by severity/priority working

### NFR Assessment

#### Security: PASS
- Input validation on all API endpoints
- Proper error handling prevents information leakage
- No sensitive data exposed in client-side state
- Coordinator authorization patterns established

#### Performance: CONCERNS
- **Issue**: Large incident datasets may cause rendering performance issues
- **Recommendation**: Implement virtual scrolling for incident lists >100 items
- API pagination implemented correctly
- Loading states prevent UI blocking

#### Reliability: PASS  
- Comprehensive error handling in components and API
- Offline state management patterns established
- Recovery mechanisms for failed operations
- Proper validation prevents data corruption

#### Maintainability: PASS
- Clean code architecture with proper separation of concerns  
- Comprehensive TypeScript typing
- Consistent coding patterns following project standards
- Well-documented component interfaces

### Compliance Check

- **Coding Standards**: ✓ Follows established React/TypeScript patterns
- **Project Structure**: ✓ Components organized in feature-based structure
- **Testing Strategy**: ✓ Unit tests present, integration tests for APIs
- **Story Requirements**: ✗ **UI integration incomplete - blocking issue**

### Critical Recommendations (BLOCKING)

#### 1. Create Page Route for Incident Management (PRIORITY 1)
**Required Files:**
- `packages/frontend/src/app/(dashboard)/coordinator/incidents/page.tsx`
- Add navigation link in coordinator dashboard
- Update sidebar navigation to include incident management

**Implementation Required:**
```typescript
// coordinator/incidents/page.tsx
export default function IncidentsPage() {
  return (
    <IncidentManagementInterface 
      coordinatorId="current-coordinator-id"
      coordinatorName="Current Coordinator Name"
    />
  );
}
```

#### 2. Navigation Integration (PRIORITY 1) 
- Add incident management card to coordinator dashboard
- Update sidebar navigation for coordinator role
- Ensure role-based access control

#### 3. Complete End-to-End Testing (PRIORITY 2)
- Test complete incident lifecycle: creation → status updates → resolution
- Verify entity linking workflows
- Performance testing with larger datasets

### Files That Require Completion

**Missing Route Files:**
- `/coordinator/incidents/page.tsx` - Main incident management page
- Navigation updates in coordinator dashboard components

**Recommended Additional Files:**
- E2E test suite for complete incident workflows
- Performance optimization for large datasets

### Gate Status

Gate: **CONCERNS** → docs/qa/gates/3.6-incident-management.yml

**Status Reason:** Backend implementation excellent but critical UI integration missing. Components orphaned without routing. Functional completeness blocked.

**Key Issues:**
- No accessible UI routes for incident management functionality  
- Navigation integration incomplete
- End-to-end user workflows untested

**Quality Score: 75/100** 
- Excellent backend implementation (+25)
- Good component architecture (+25) 
- Good test coverage (+25)
- Major UI integration gap (-25)

### Recommended Status

**✗ Changes Required - Critical UI Integration Missing**

**Next Steps:**
1. Create page routes for incident management UI access
2. Integrate navigation links in coordinator dashboard  
3. Test complete end-to-end workflows
4. Only then can story be marked as Done

**Story Implementation: 75% Complete**
- Backend/API: 100% ✓
- Components: 100% ✓  
- Data Management: 100% ✓
- Testing: 80% ✓
- **UI Integration: 0% ✗ (BLOCKING)**